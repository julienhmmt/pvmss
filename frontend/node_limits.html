{{define "node_limits.html"}}
<div class="container">
    <h2 class="title is-4">{{.AdminLimitsTitle}}</h2>
    <div class="notification is-light">
        {{.AdminLimitsDescription}}
    </div>

    <div id="limits-container" class="mb-4">
    {{range .NodeDetails}}
    <div class="card mb-5" id="node-{{.Node}}">
        <header class="card-header">
            <p class="card-header-title">{{$.AdminLimitsNodeLabel}} {{.Node}}</p>
        </header>
        <div class="card-content">
            <div class="content">
                <p><strong>{{$.AdminLimitsAvailableSockets}}:</strong> {{if .Sockets}}{{.Sockets}}{{else}}1{{end}} | <strong>{{$.AdminLimitsAvailableCores}}:</strong> {{.MaxCPU}} | <strong>{{$.AdminLimitsAvailableMemory}}:</strong> {{.MaxMemory | humanBytes}}</p>
                <hr>
                <div class="columns">
                    <!-- Sockets -->
                    <div class="column">
                        <label class="label">{{$.AdminLimitsSockets}}</label>
                        <div class="field is-horizontal">
                            <div class="field-body">
                                <div class="field">
                                    <p class="control">
                                        <input class="input" type="number" id="sockets-min-{{.Node}}" min="1" value="{{if index $.Settings.Limits .Node}}{{(index $.Settings.Limits .Node).Sockets.Min}}{{else}}1{{end}}" placeholder="{{$.AdminLimitsMinPlaceholder}}">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control">
                                        <input class="input" type="number" id="sockets-max-{{.Node}}" value="{{if index $.Settings.Limits .Node}}{{(index $.Settings.Limits .Node).Sockets.Max}}{{else}}0{{end}}" placeholder="{{$.AdminLimitsMaxPlaceholder}}">
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Cores -->
                    <div class="column">
                        <label class="label">{{$.AdminLimitsCores}}</label>
                        <div class="field is-horizontal">
                            <div class="field-body">
                                <div class="field">
                                    <p class="control">
                                        <input class="input" type="number" id="cores-min-{{.Node}}" min="1" value="{{if index $.Settings.Limits .Node}}{{(index $.Settings.Limits .Node).Cores.Min}}{{else}}1{{end}}" placeholder="{{$.AdminLimitsMinPlaceholder}}">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control">
                                        <input class="input" type="number" id="cores-max-{{.Node}}" value="{{if index $.Settings.Limits .Node}}{{(index $.Settings.Limits .Node).Cores.Max}}{{else}}0{{end}}" placeholder="{{$.AdminLimitsMaxPlaceholder}}">
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Memory (RAM) in GB -->
                    <div class="column">
                        <label class="label">{{$.AdminLimitsMemoryGB}}</label>
                        <div class="field is-horizontal">
                            <div class="field-body">
                                <div class="field">
                                    <p class="control">
                                        <input class="input" type="number" id="ram-min-{{.Node}}" value="{{if index $.Settings.Limits .Node}}{{(index $.Settings.Limits .Node).RAM.Min}}{{else}}0{{end}}" placeholder="{{$.AdminLimitsMinGBPlaceholder}}">
                                    </p>
                                </div>
                                <div class="field">
                                    <p class="control">
                                        <input class="input" type="number" id="ram-max-{{.Node}}" value="{{if index $.Settings.Limits .Node}}{{(index $.Settings.Limits .Node).RAM.Max}}{{else}}0{{end}}" placeholder="{{$.AdminLimitsMaxGBPlaceholder}}">
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="card-footer">
            <a href="#" class="card-footer-item save-limits-btn" data-node="{{.Node}}">{{$.AdminLimitsSaveButton}}</a>
        </footer>
    </div>
    {{else}}
    <div class="notification is-warning">
        {{$.AdminLimitsNoNodes}}
    </div>
    {{end}}
</div>

<script>
// Limits management script with automatic saving on input change
document.addEventListener('DOMContentLoaded', function () {
    if (window.limitsInitialized) return;
    window.limitsInitialized = true;

    const i18n = {
        saveSuccess: '{{$.AdminLimitsSaveSuccess}}',
        saveFailed: '{{$.AdminLimitsSaveFailed}}',
        errorOccurred: '{{$.AdminLimitsErrorOccurred}}'
    };

    // Utility to collect values for a node and enforce minimums
    function collectLimits(nodeName) {
        const socketsMin = Math.max(1, parseInt(document.getElementById(`sockets-min-${nodeName}`).value) || 1);
        const coresMin = Math.max(1, parseInt(document.getElementById(`cores-min-${nodeName}`).value) || 1);
        return {
            node: nodeName,
            sockets: {
                min: socketsMin,
                max: parseInt(document.getElementById(`sockets-max-${nodeName}`).value) || socketsMin
            },
            cores: {
                min: coresMin,
                max: parseInt(document.getElementById(`cores-max-${nodeName}`).value) || coresMin
            },
            ram: {
                min: parseInt(document.getElementById(`ram-min-${nodeName}`).value) || 0,
                max: parseInt(document.getElementById(`ram-max-${nodeName}`).value) || 0
            }
        };
    }

    // Save limits to backend and give feedback
    function saveLimits(nodeName) {
        const limits = collectLimits(nodeName);
        fetch('/api/limits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(limits)
        }).then(response => {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        }).then(data => {
            if (data.limits) {
                // Reflect any server-side adjustments
                ['sockets', 'cores', 'ram'].forEach(key => {
                    if (data.limits[key]) {
                        document.getElementById(`${key}-min-${nodeName}`).value = data.limits[key].min;
                        document.getElementById(`${key}-max-${nodeName}`).value = data.limits[key].max;
                    }
                });
            }
            if (data.validationMessages && data.validationMessages.length) {
                console.warn('Validation:', data.validationMessages.join('\n'));
            }
            console.info(i18n.saveSuccess.replace('{{.NodeName}}', nodeName));
        }).catch(err => {
            console.error('Save failed', err);
            alert(i18n.saveFailed.replace('{{.NodeName}}', nodeName));
        });
    }

    // Manual save button (still present)
    document.querySelectorAll('.save-limits-btn').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            saveLimits(btn.dataset.node);
        });
    });

    // Automatic save on any input change within a node card
    document.querySelectorAll('.card[id^="node-"]').forEach(card => {
        const nodeName = card.id.replace('node-', '');
        card.querySelectorAll('input').forEach(inp => {
            inp.addEventListener('change', () => saveLimits(nodeName));
        });
    });
});
</script>
</div>
{{end}}
