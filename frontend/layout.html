{{define "layout"}}
<!DOCTYPE html>
<html lang="{{.Lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{{.UI.Header}} - {{.UI.Subtitle}}">
    <meta name="csrf-token" content="{{.CSRFToken}}">
    <title>{{.Title}} - {{.UI.Header}}</title>
    <link rel="stylesheet" href="/css/bulma.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/css/fontawesome.min.css">
    <link rel="stylesheet" href="/css/solid.min.css">
    <link rel="stylesheet" href="/css/regular.min.css">
    <link rel="stylesheet" href="/css/brands.min.css">
</head>
<body>
    
    {{template "navbar" .}}

    {{/* Proxmox Connection Status Banner */}}
    {{if not .ProxmoxConnected}}
    <div class="notification is-danger is-light" id="proxmox-status-banner">
        <div class="level is-mobile">
            <div class="level-left">
                <div class="level-item">
                    <span class="icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                </div>
                <div class="level-item">
                    <strong>{{index .t "Proxmox.ConnectionError"}}:</strong> {{.ProxmoxError}}
                </div>
            </div>
            <div class="level-right">
                <button class="delete" onclick="document.getElementById('proxmox-status-banner').style.display='none'; document.getElementById('main-content').style.marginTop='3.25rem';"></button>
            </div>
        </div>
    </div>
    {{end}}

    <main id="main-content" class="section">
        <div class="container">
            {{if .Content}}
                {{.Content}}
            {{else}}
                {{/* Default content if no content template is defined */}}
                <h1 class="title">{{index .t "Title"}}</h1>
                <p>No content available</p>
            {{end}}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="content has-text-centered">
                <p>
                    <span class="icon-text">
                        <span class="icon">
                            <i class="fas fa-server"></i>
                        </span>
                        <span>{{index .t "UI.Footer"}}</span>
                    </span>
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Fonction utilitaire pour récupérer le jeton CSRF
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]')?.content || 
                   document.querySelector('input[name="csrf_token"]')?.value || '';
        }

        // Check Proxmox connection status
        function checkProxmoxStatus() {
            fetch('/api/health/proxmox')
                .then(response => response.json())
                .then(data => {
                    const banner = document.getElementById('proxmox-status-banner');
                    const statusText = banner ? banner.querySelector('.status-text') : null;
                    
                    if (data.connected) {
                        if (banner) banner.style.display = 'none';
                    } else {
                        if (!banner) {
                            // Create banner if it doesn't exist
                            const newBanner = document.createElement('div');
                            newBanner.id = 'proxmox-status-banner';
                            newBanner.className = 'notification is-danger is-light';
                            newBanner.style.marginBottom = '0';
                            newBanner.style.borderRadius = '0';
                            newBanner.innerHTML = `
                                <div class="container">
                                    <div class="level is-mobile">
                                        <div class="level-left">
                                            <div class="level-item">
                                                <span class="icon">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                </span>
                                            </div>
                                            <div class="level-item status-text">
                                                <strong>Proxmox Connection Error:</strong> ${data.error || 'Unable to connect to Proxmox server'}
                                            </div>
                                        </div>
                                        <div class="level-right">
                                            <button class="delete" onclick="this.parentElement.parentElement.parentElement.style.display='none';"></button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            const mainContent = document.querySelector('main');
                            if (mainContent) {
                                mainContent.parentNode.insertBefore(newBanner, mainContent);
                            }
                        } else if (statusText) {
                            // Update existing banner
                            statusText.innerHTML = `<strong>Proxmox Connection Error:</strong> ${data.error || 'Unable to connect to Proxmox server'}`;
                            banner.style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking Proxmox status:', error);
                });
        }

        // Gestion du menu burger
        document.addEventListener('DOMContentLoaded', function() {
            const burger = document.querySelector('.navbar-burger');
            const menu = document.querySelector('.navbar-menu');
            
            if (burger && menu) {
                burger.addEventListener('click', function() {
                    burger.classList.toggle('is-active');
                    menu.classList.toggle('is-active');
                });
            }

            // Ajouter le jeton CSRF à toutes les requêtes AJAX par défaut
            document.addEventListener('htmx:configRequest', function(event) {
                const csrfToken = getCSRFToken();
                if (csrfToken && !event.detail.headers['X-CSRF-Token']) {
                    event.detail.headers['X-CSRF-Token'] = csrfToken;
                }
            });

            // Check Proxmox status on page load
            checkProxmoxStatus();
            
            // Check Proxmox status every 30 seconds
            setInterval(checkProxmoxStatus, 30000);
        });
    </script>
</body>
</html>
{{end}}