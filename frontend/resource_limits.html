{{define "resource_limits"}}
<div class="container">
    <div class="title is-4">
        <h2 class="title is-4">{{index .t "Admin.Limits.Title"}}</h2>
    </div>

    <div class="notification is-light">
        {{index .t "Admin.Limits.Description"}}
    </div>

    <!-- VM Limits -->
    <div id="vm-limits" class="mb-4">
        <form class="limits-form" data-entity-id="vm" action="/api/limits" method="POST">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <div class="card">
                <div class="card-content">
                    <div class="columns">
                        <!-- Sockets -->
                        <div class="column is-6">
                            <div class="box">
                                <div class="level is-mobile">
                                    <div class="level-item">
                                        <h3 class="title is-6">{{index .t "Admin.Limits.Sockets"}}</h3>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Min"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control is-expanded">
                                                <input class="input is-info" type="number" name="sockets-min" id="sockets-min-vm" 
                                                       value="{{if .Settings.Limits.vm.sockets}}{{.Settings.Limits.vm.sockets.min}}{{else}}1{{end}}" 
                                                       min="1" 
                                                       max="{{if .Settings.Limits.vm.sockets}}{{.Settings.Limits.vm.sockets.max}}{{else}}16{{end}}" 
                                                       readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Max"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control is-expanded">
                                                <input class="input is-primary" type="number" name="sockets-max" id="sockets-max-vm" 
                                                       value="{{if .Settings.Limits.vm.sockets}}{{.Settings.Limits.vm.sockets.max}}{{else}}2{{end}}" 
                                                       min="1" max="16" step="1"
                                                       data-validate-min="sockets-min-vm">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Cores -->
                        <div class="column is-6">
                            <div class="box">
                                <div class="level is-mobile">
                                    <div class="level-item">
                                        <h3 class="title is-6">{{index .t "Admin.Limits.Cores"}}</h3>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Min"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control is-expanded">
                                                <input class="input" type="number" name="cores-min" 
                                                       id="cores-min-vm" 
                                                       value="{{if .Settings.Limits.vm.cores}}{{.Settings.Limits.vm.cores.min}}{{else}}1{{end}}" 
                                                       min="1" max="{{if .Settings.Limits.vm.cores}}{{.Settings.Limits.vm.cores.max}}{{else}}32{{end}}" 
                                                       readonly>
                                            </div>
                                            <p class="help">{{index . "Admin.Limits.CoresMinHelp"}}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Max"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control is-expanded">
                                                <input class="input" type="number" name="cores-max" 
                                                       id="cores-max-vm" 
                                                       value="{{if .Settings.Limits.vm.cores}}{{.Settings.Limits.vm.cores.max}}{{else}}32{{end}}" 
                                                       min="1" max="128" step="1"
                                                       data-validate-min="cores-min-vm">
                                            </div>
                                            <p class="help">{{index . "Admin.Limits.CoresMaxHelp"}}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Second row for RAM and Disk -->
                    <div class="columns">
                        <!-- RAM -->
                        <div class="column is-6">
                            <div class="box">
                                <div class="level is-mobile">
                                    <div class="level-item">
                                        <h3 class="title is-6">{{index .t "Admin.Limits.Memory"}}</h3>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Min"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control has-icons-right is-expanded">
                                                <input class="input" type="number" name="ram-min" 
                                                       id="ram-min-vm" 
                                                       value="{{if .Settings.Limits.vm.ram}}{{.Settings.Limits.vm.ram.min}}{{else}}1{{end}}" 
                                                       min="1" max="{{if .Settings.Limits.vm.ram}}{{.Settings.Limits.vm.ram.max}}{{else}}64{{end}}" 
                                                       readonly>
                                                <span class="icon is-small is-right">Go</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Max"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control has-icons-right is-expanded">
                                                <input class="input" type="number" name="ram-max" 
                                                       id="ram-max-vm" 
                                                       value="{{if .Settings.Limits.vm.ram}}{{.Settings.Limits.vm.ram.max}}{{else}}64{{end}}" 
                                                       min="1" max="512" step="1"
                                                       data-validate-min="ram-min-vm">
                                                <span class="icon is-small is-right">Go</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Disk -->
                        <div class="column is-6">
                            <div class="box">
                                <div class="level is-mobile">
                                    <div class="level-item">
                                        <h3 class="title is-6">{{index .t "Admin.Limits.Disk"}}</h3>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Min"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control has-icons-right is-expanded">
                                                <input class="input" type="number" name="disk-min" 
                                                       id="disk-min-vm" 
                                                       value="{{if .Settings.Limits.vm.disk}}{{.Settings.Limits.vm.disk.min}}{{else}}10{{end}}" 
                                                       min="1" max="{{if .Settings.Limits.vm.disk}}{{.Settings.Limits.vm.disk.max}}{{else}}500{{end}}" 
                                                       readonly>
                                                <span class="icon is-small is-right">Go</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field is-horizontal">
                                    <div class="field-label is-normal">
                                        <label class="label">{{index .t "Common.Max"}}</label>
                                    </div>
                                    <div class="field-body">
                                        <div class="field">
                                            <div class="control has-icons-right is-expanded">
                                                <input class="input" type="number" name="disk-max" 
                                                       id="disk-max-vm" 
                                                       value="{{if .Settings.Limits.vm.disk}}{{.Settings.Limits.vm.disk.max}}{{else}}500{{end}}" 
                                                       min="1" max="2048" step="1"
                                                       data-validate-min="disk-min-vm">
                                                <span class="icon is-small is-right">Go</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="columns">
                        <div class="column is-12">
                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <button type="button" class="button is-light is-outlined mr-2 reset-btn" data-entity-id="vm" title='{{index . "Common.Reset"}}'>
                                        <span>{{index . "Common.Reset"}}</span>
                                    </button>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-primary is-outlined save-limits-btn" title='{{index . "Common.Save"}}'>
                                        <span>{{index . "Common.Save"}}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle refresh button click
            const refreshButton = document.getElementById('refresh-limits');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    window.location.reload();
                });
            }
            const refreshBtn = document.getElementById('refresh-limits');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    this.classList.add('is-loading');
                    setTimeout(() => { window.location.reload(); }, 500);
                });
            }

            // Validation des champs min/max
            document.querySelectorAll('input[type="number"][data-validate-min]').forEach(maxInput => {
                maxInput.addEventListener('change', function() {
                    const minInput = document.getElementById(this.getAttribute('data-validate-min'));
                    if (minInput) {
                        const minVal = parseInt(minInput.value) || 0;
                        const maxVal = parseInt(this.value) || 0;
                        if (minVal > maxVal) {
                            minInput.value = maxVal;
                            showNotification('warning', '{{index . "Admin.Limits.WarningAdjusted"}}');
                        }
                    }
                });
            });

            // Gestion de la soumission des formulaires
            document.querySelectorAll('.limits-form').forEach(form => {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const submitBtn = this.querySelector('.save-limits-btn');
                    const originalText = submitBtn?.innerHTML;
                    if (submitBtn) {
                        submitBtn.classList.add('is-loading');
                        submitBtn.disabled = true;
                    }

                    try {
                        const formData = new FormData(this);
                        const data = Object.fromEntries(formData.entries());

                        const response = await fetch('/api/limits/' + this.dataset.entityId, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();
                        if (response.ok && result.success) {
                            showNotification('success', result.message || '{{index . "Admin.Limits.SuccessNotification"}}');
                        } else {
                            throw new Error(result.message || '{{index . "Admin.Limits.ErrorUpdate"}}');
                        }
                    } catch (error) {
                        console.error('Error updating limits:', error);
                        showNotification('danger', error.message || '{{index . "Admin.Limits.ErrorUpdateGeneric"}}');
                    } finally {
                        if (submitBtn) {
                            submitBtn.classList.remove('is-loading');
                            submitBtn.disabled = false;
                            if (originalText) submitBtn.innerHTML = originalText;
                        }
                    }
                });
            });

            // Gestion des boutons de réinitialisation
            document.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('{{index . "Admin.Limits.ConfirmReset"}}')) {
                        const form = this.closest('form');
                        form.querySelectorAll('input[type="number"]').forEach(input => {
                            if (input.name.includes('-max')) {
                                input.value = input.getAttribute('max') || '16';
                            }
                        });
                        showNotification('info', '{{index . "Admin.Limits.ResetNotification"}}');
                    }
                });
            });

            // Fonction pour afficher des notifications
            function showNotification(type, message) {
                const container = document.getElementById('notification-container') || document.body;
                const notification = document.createElement('div');
                notification.className = `notification is-${type} is-light is-fixed-bottom-right`;
                notification.innerHTML = `<button class="delete"></button>${message}`;
                container.appendChild(notification);
                notification.querySelector('.delete').addEventListener('click', () => notification.remove());
                setTimeout(() => notification.remove(), 5000);
            }
        });
    </script>


<script src="/js/limits.js"></script>
</body>
</html>
{{end}}