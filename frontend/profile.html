{{define "profile"}}
{{$lang := .Lang}}

<!-- User Profile Page -->
<section class="section">
    <div class="container">
        <div class="columns is-centered">
            <div class="column is-10">
                <div class="card admin-card">
                    <header class="card-header brand-header is-align-items-center">
                        <p class="card-header-title">
                            <span class="icon"><i class="fas fa-user-circle"></i></span>&nbsp;{{T "Profile.Title"}}
                        </p>
                    </header>
                    <div class="card-content">
                        <!-- User Information -->
                        <div class="box has-background-light mb-5">
                            <div class="columns is-mobile is-multiline">
                                <div class="column is-12-mobile is-6-tablet">
                                    <div class="field">
                                        <label class="label has-text-grey">{{T "Profile.Username"}}</label>
                                        <p class="is-size-5 has-text-weight-semibold">
                                            <span class="icon-text">
                                                <span class="icon has-text-primary">
                                                    <i class="fas fa-user"></i>
                                                </span>
                                                <span>{{.Username}}</span>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <div class="column is-12-mobile is-6-tablet">
                                    <div class="field">
                                        <label class="label has-text-grey">{{T "Profile.Pool"}}</label>
                                        <p class="is-size-5 has-text-weight-semibold">
                                            <span class="icon-text">
                                                <span class="icon has-text-info">
                                                    <i class="fas fa-layer-group"></i>
                                                </span>
                                                <span>{{.PoolName}}</span>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Password Change Section -->
                        <div class="box mb-5">
                            <h2 class="title is-5 mb-4">
                                <span class="icon-text">
                                    <span class="icon has-text-warning">
                                        <i class="fas fa-key"></i>
                                    </span>
                                    <span>{{T "Profile.ChangePassword"}}</span>
                                </span>
                            </h2>

                            {{if .PasswordSuccess}}
                            {{template "notification" (dict 
                              "Type" "success" 
                              "Message" (T "Profile.PasswordUpdateSuccess")
                              "Icon" "fas fa-check-circle" 
                              "Dismissible" true
                            )}}
                            {{end}}

                            {{if .PasswordError}}
                            {{template "notification" (dict 
                              "Type" "danger" 
                              "Message" .PasswordError
                              "Icon" "fas fa-exclamation-triangle" 
                              "Dismissible" true
                            )}}
                            {{end}}

                            {{if .ShowPasswordForm}}
                            <form method="POST" action="{{withLang "/profile/update-password" $lang}}">
                                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                                
                                <div class="field">
                                    <label class="label">{{T "Profile.CurrentPassword"}}</label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="password" name="current_password" placeholder="{{T "Profile.CurrentPasswordPlaceholder"}}" required minlength="5" autofocus>
                                        <span class="icon is-small is-left"><i class="fas fa-lock"></i></span>
                                    </div>
                                    <p class="help">{{T "Profile.CurrentPasswordHelp"}}</p>
                                </div>

                                <div class="field">
                                    <label class="label">{{T "Profile.NewPassword"}}</label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="password" name="new_password" placeholder="{{T "Profile.NewPasswordPlaceholder"}}" required minlength="5">
                                        <span class="icon is-small is-left"><i class="fas fa-key"></i></span>
                                    </div>
                                    <p class="help">{{T "Profile.NewPasswordHelp"}}</p>
                                </div>

                                <div class="field">
                                    <label class="label">{{T "Profile.ConfirmPassword"}}</label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="password" name="confirm_password" placeholder="{{T "Profile.ConfirmPasswordPlaceholder"}}" required minlength="5">
                                        <span class="icon is-small is-left"><i class="fas fa-key"></i></span>
                                    </div>
                                </div>

                                <div class="field is-grouped">
                                    <div class="control">
                                        <button type="submit" class="button is-warning">
                                            <span class="icon"><i class="fas fa-save"></i></span>
                                            <span>{{T "Profile.UpdatePassword"}}</span>
                                        </button>
                                    </div>
                                    <div class="control">
                                        <a href="{{withLang "/profile" $lang}}" class="button is-light">
                                            <span class="icon"><i class="fas fa-times"></i></span>
                                            <span>{{T "Common.Cancel"}}</span>
                                        </a>
                                    </div>
                                </div>
                            </form>
                            {{else}}
                            <p class="mb-3">{{T "Profile.PasswordChangeDescription"}}</p>
                            <a href="{{withLang "/profile?show_password_form=1" $lang}}" class="button is-warning">
                                <span class="icon"><i class="fas fa-key"></i></span>
                                <span>{{T "Profile.ChangePasswordButton"}}</span>
                            </a>
                            {{end}}
                        </div>

                        <!-- VMs Section -->
                        <div class="content">
                            <h2 class="title is-5 mb-4">
                                <span class="icon-text">
                                    <span class="icon">
                                        <i class="fas fa-server"></i>
                                    </span>
                                    <span>{{T "Profile.MyVMs"}}</span>
                                </span>
                            </h2>

                            {{if .ProxmoxError}}
                            {{template "notification" (dict 
                              "Type" "warning" 
                              "Title" (T "Proxmox.ConnectionError")
                              "Message" (T "Proxmox.NotConnected") 
                              "Icon" "fas fa-exclamation-triangle" 
                              "Dismissible" false 
                              "Live" "polite"
                            )}}
                            {{else if .VMs}}
                            <div class="table-container">
                                <table class="table is-fullwidth is-hoverable is-striped">
                                    <thead>
                                        <tr>
                                            <th class="has-text-centered">{{T "Profile.VMID"}}</th>
                                            <th>{{T "Profile.VMName"}}</th>
                                            <th class="has-text-centered">{{T "Profile.Node"}}</th>
                                            <th class="has-text-centered">{{T "Profile.Status"}}</th>
                                            <th class="has-text-centered">{{T "Profile.Actions"}}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{range .VMs}}
                                        <tr>
                                            <td class="has-text-centered has-text-weight-semibold">
                                                {{.VMID}}
                                            </td>
                                            <td>
                                                <span class="icon-text">
                                                    <span class="icon has-text-grey">
                                                        <i class="fas fa-desktop"></i>
                                                    </span>
                                                    <span>{{if .Name}}{{.Name}}{{else}}-{{end}}</span>
                                                </span>
                                            </td>
                                            <td class="has-text-centered">
                                                <span class="tag is-light">{{.Node}}</span>
                                            </td>
                                            <td class="has-text-centered">
                                                {{template "status_badge" (dict "Status" .Status "WithIcon" true)}}
                                            </td>
                                            <td class="has-text-centered">
                                                <div class="buttons is-centered">
                                                    <a href="{{withLang (printf "/vm/details/%d" .VMID) $lang}}" 
                                                       class="button is-small is-primary">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-circle-info"></i>
                                                        </span>
                                                        <span>{{T "Profile.ViewDetails"}}</span>
                                                    </a>
                                                    <a href="{{withLang (printf "/vm/delete/%d" .VMID) $lang}}" 
                                                       class="button is-small is-danger">
                                                        <span class="icon is-small">
                                                            <i class="fas fa-trash-alt"></i>
                                                        </span>
                                                        <span>{{T "Profile.Delete"}}</span>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {{end}}
                                    </tbody>
                                </table>
                            </div>
                            {{else}}
                            <div class="notification is-info is-light">
                                <div class="content has-text-centered">
                                    <p class="is-size-5">
                                        <span class="icon is-large">
                                            <i class="fas fa-inbox fa-2x"></i>
                                        </span>
                                    </p>
                                    <p class="has-text-weight-semibold">{{T "Profile.NoVMs"}}</p>
                                    <p class="has-text-grey">{{T "Profile.NoVMsMessage"}}</p>
                                    <div class="buttons is-centered mt-4">
                                        <a href="{{withLang "/vm/create" $lang}}" class="button is-primary">
                                            <span class="icon">
                                                <i class="fas fa-plus"></i>
                                            </span>
                                            <span>{{T "Profile.CreateFirstVM"}}</span>
                                        </a>
                                    </div>
                            </div>
                            {{end}}
                        </div>

                        <!-- Quick Actions -->
        <div class="buttons is-centered mt-5">
            <a href="{{withLang "/vm/create" $lang}}" class="button is-primary">
                <span class="icon">
                    <i class="fas fa-plus-square"></i>
                </span>
                <span>{{T "Profile.CreateVM"}}</span>
            </a>
            <a href="{{withLang "/search" $lang}}" class="button is-link is-light">
                <span class="icon">
                    <i class="fas fa-search"></i>
                </span>
                <span>{{T "Profile.SearchVM"}}</span>
            </a>
            <a href="{{withLang "/profile?refresh=1" $lang}}" class="button is-light">
                <span class="icon">
                    <i class="fas fa-sync-alt"></i>
                </span>
                <span>{{T "Common.Refresh"}}</span>
            </a>
        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{{end}}
