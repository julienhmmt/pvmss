{{define "profile"}}
{{$lang := .Lang}}

<section class="section">
    <div class="container">
        <!-- Page Header with Quick Actions -->
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <h1 class="title is-3">
                        <span class="icon-text">
                            <span class="icon has-text-primary">
                                <i class="fas fa-user-circle"></i>
                            </span>
                            <span>{{T "Profile.Title"}}</span>
                        </span>
                    </h1>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="buttons">
                        <a href="/vm/create" class="button is-primary">
                            <span class="icon"><i class="fas fa-plus-square"></i></span>
                            <span>{{T "Profile.CreateVM"}}</span>
                        </a>
                        <a href="/search" class="button is-primary is-light has-text-dark">
                            <span class="icon"><i class="fas fa-search"></i></span>
                            <span>{{T "Profile.SearchVM"}}</span>
                        </a>
                        <a href="/profile?refresh=1" class="button is-light">
                            <span class="icon"><i class="fas fa-sync-alt"></i></span>
                            <span>{{T "Common.Refresh"}}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Card - Alternative Modern Layout -->
        <div class="card mb-5">
            <div class="card-content py-4 px-5">
                <!-- Top Section: User Info + Stats in one line -->
                <div class="level is-mobile mb-3">
                    <div class="level-left">
                        <div class="level-item">
                            <span class="icon has-text-primary mr-3" style="font-size: 2.25rem;">
                                <i class="fas fa-user-circle"></i>
                            </span>
                            <div>
                                <p class="title is-5 mb-1">{{.Username}}</p>
                                <p class="is-size-7 has-text-grey">
                                    <span class="icon is-small has-text-info">
                                        <i class="fas fa-layer-group"></i>
                                    </span>
                                    <span class="has-text-weight-semibold">{{.PoolName}}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <span class="icon is-small has-text-primary mr-1">
                                <i class="fas fa-chart-line"></i>
                            </span>
                            <span class="is-size-7 has-text-grey-dark has-text-weight-semibold">{{T "Profile.Overview"}}</span>
                        </div>
                    </div>
                </div>

                <hr class="my-3" style="background-color: rgb(0,0,0,6%);">

                <!-- Stats Section: Horizontal inline stats with dividers -->
                {{if .VMs}}
                <div class="columns is-mobile is-variable is-1 has-text-centered">
                    <div class="column">
                        <div class="py-2">
                            <p class="heading is-size-7 mb-1 has-text-grey">{{T "Profile.TotalVMs"}}</p>
                            <p class="title is-4 mb-0 has-text-primary">
                                <span>{{len .VMs}}</span>
                            </p>
                        </div>
                    </div>
                    <div class="column is-narrow px-0">
                        <div class="py-2" style="border-left: 2px solid rgb(0,0,0,6%); height: 100%;"></div>
                    </div>
                    <div class="column">
                        <div class="py-2">
                            <p class="heading is-size-7 mb-1 has-text-grey">{{T "Profile.RunningVMs"}}</p>
                            <p class="title is-4 mb-0 has-text-success">
                                {{$running := 0}}
                                {{range .VMs}}{{if eq .Status "running"}}{{$running = add $running 1}}{{end}}{{end}}
                                <span>{{$running}}</span>
                            </p>
                        </div>
                    </div>
                    <div class="column is-narrow px-0">
                        <div class="py-2" style="border-left: 2px solid rgb(0,0,0,6%); height: 100%;"></div>
                    </div>
                    <div class="column">
                        <div class="py-2">
                            <p class="heading is-size-7 mb-1 has-text-grey">{{T "Profile.StoppedVMs"}}</p>
                            <p class="title is-4 mb-0 has-text-warning">
                                {{$stopped := 0}}
                                {{range .VMs}}{{if eq .Status "stopped"}}{{$stopped = add $stopped 1}}{{end}}{{end}}
                                <span>{{$stopped}}</span>
                            </p>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="has-text-centered py-3">
                    <span class="icon has-text-grey-lighter mb-2">
                        <i class="fas fa-server fa-lg"></i>
                    </span>
                    <p class="is-size-7 has-text-grey">{{T "Profile.NoVMs"}}</p>
                </div>
                {{end}}
            </div>
        </div>

        <!-- VMs List Section -->
        <div class="card mb-5">
            <header class="card-header brand-header">
                <p class="card-header-title">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-server"></i></span>
                        <span>{{T "Profile.MyVMs"}}</span>
                    </span>
                </p>
            </header>
            <div class="card-content">
                {{if .ProxmoxError}}
                {{template "notification" (dict 
                  "Type" "warning" 
                  "Title" (T "Proxmox.ConnectionError")
                  "Message" (T "Proxmox.NotConnected") 
                  "Icon" "fas fa-exclamation-triangle" 
                  "Dismissible" false 
                  "Live" "polite"
                )}}
                {{else if .VMs}}
                <div class="table-container">
                    <table class="table is-fullwidth is-hoverable">
                        <thead>
                            <tr class="has-background-light">
                                <th class="has-text-centered" width="100">
                                    <span>{{T "Profile.VMID"}}</span>
                                </th>
                                <th>
                                    <span>{{T "Profile.VMName"}}</span>
                                </th>
                                <th>
                                    <span>{{T "Profile.Description"}}</span>
                                </th>
                                <th class="has-text-centered" width="150">
                                    <span>{{T "Profile.Node"}}</span>
                                </th>
                                <th class="has-text-centered" width="150">
                                    <span>
                                        {{T "Profile.Status"}}
                                    </span>
                                </th>
                                <th class="has-text-centered" width="280">
                                    <span>{{T "Profile.Actions"}}</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .VMs}}
                            <tr class="is-size-6">
                                <td class="has-text-centered is-vcentered">
                                    <span class="tag is-light is-medium has-text-weight-bold">{{.VMID}}</span>
                                </td>
                                <td class="is-vcentered">
                                    <div class="is-flex is-align-items-center">
                                        <span class="has-text-weight-semibold">{{if .Name}}{{.Name}}{{else}}<em class="has-text-grey-light">Sans nom</em>{{end}}</span>
                                    </div>
                                </td>
                                <td class="is-vcentered">
                                    <span class="is-size-7">{{if .Description}}{{.Description}}{{else}}<em class="has-text-grey-light">{{T "Profile.NoDescription"}}</em>{{end}}</span>
                                </td>
                                <td class="has-text-centered is-vcentered">
                                    <span class="tag is-small">{{.Node}}</span>
                                </td>
                                <td class="has-text-centered is-vcentered">
                                    {{template "status_badge" (dict "Status" .Status "WithIcon" true)}}
                                </td>
                                <td class="has-text-centered is-vcentered">
                                    <div class="buttons is-centered mb-0">
                                        <a href="{{printf "/vm/details/%d" .VMID}}" 
                                           class="button is-small is-primary"
                                           title="{{T "Profile.ViewDetails"}}">
                                            <span class="icon">
                                                <i class="fas fa-eye"></i>
                                            </span>
                                            <span>{{T "Profile.ViewDetails"}}</span>
                                        </a>
                                        <a href="{{printf "/vm/delete/%d" .VMID}}" 
                                           class="button is-small is-danger has-text-white"
                                           title="{{T "Profile.Delete"}}">
                                            <span class="icon">
                                                <i class="fas fa-trash-alt"></i>
                                            </span>
                                            <span>{{T "Profile.Delete"}}</span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                {{template "empty_state" (dict 
                  "Icon" "fas fa-inbox fa-2x"
                  "Title" (T "Profile.NoVMs")
                  "Message" (T "Profile.NoVMsMessage")
                  "Action" (dict 
                    "Link" "/vm/create"
                    "Text" (T "Profile.CreateFirstVM")
                    "Icon" "fas fa-plus"
                    "Type" "primary"
                  )
                )}}
                {{end}}
            </div>
        </div>

        <!-- Security Section -->
        <div class="card">
            <header class="card-header brand-header">
                <p class="card-header-title is-size-6">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-shield-halved"></i></span>
                        <span>{{T "Profile.Security"}}</span>
                    </span>
                </p>
            </header>
            <div class="card-content py-4">
                {{if .PasswordSuccess}}
                {{template "notification" (dict 
                  "Type" "success" 
                  "Message" (T "Profile.PasswordUpdateSuccess")
                  "Icon" "fas fa-check-circle" 
                  "Dismissible" true
                )}}
                {{end}}

                {{if .PasswordError}}
                {{template "notification" (dict 
                  "Type" "danger" 
                  "Message" .PasswordError
                  "Icon" "fas fa-exclamation-triangle" 
                  "Dismissible" true
                )}}
                {{end}}

                {{if .ShowPasswordForm}}
                <div class="columns is-variable is-5">
                    <div class="column is-12-tablet is-4-desktop">
                        <div class="box has-background-light has-text-centered py-4 px-3">
                            <span class="icon has-text-warning mb-2" style="font-size: 2rem;">
                                <i class="fas fa-key"></i>
                            </span>
                            <h3 class="title is-6 mb-2">{{T "Profile.ChangePassword"}}</h3>
                            <p class="is-size-7 has-text-grey-dark">{{T "Profile.ChangePasswordDescription"}}</p>
                        </div>
                    </div>

                    <div class="column is-12-tablet is-8-desktop">
                        <form method="POST" action="/profile/update-password" class="box py-4">
                            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                            
                            <div class="field">
                                <label class="label is-size-7 has-text-weight-semibold">
                                    <span class="icon-text">
                                        <span class="icon is-small has-text-grey"><i class="fas fa-lock"></i></span>
                                        <span>{{T "Profile.CurrentPassword"}}</span>
                                    </span>
                                </label>
                                <div class="control has-icons-left">
                                    <input class="input is-small" type="password" name="current_password" placeholder="{{T "Profile.CurrentPasswordPlaceholder"}}" required minlength="5" autofocus>
                                    <span class="icon is-small is-left"><i class="fas fa-lock"></i></span>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label is-size-7 has-text-weight-semibold">
                                    <span class="icon-text">
                                        <span class="icon is-small has-text-grey"><i class="fas fa-key"></i></span>
                                        <span>{{T "Profile.NewPassword"}}</span>
                                    </span>
                                </label>
                                <div class="control has-icons-left">
                                    <input class="input is-small" type="password" name="new_password" placeholder="{{T "Profile.NewPasswordPlaceholder"}}" required minlength="5">
                                    <span class="icon is-small is-left"><i class="fas fa-key"></i></span>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label is-size-7 has-text-weight-semibold">
                                    <span class="icon-text">
                                        <span class="icon is-small has-text-grey"><i class="fas fa-check-double"></i></span>
                                        <span>{{T "Profile.ConfirmPassword"}}</span>
                                    </span>
                                </label>
                                <div class="control has-icons-left">
                                    <input class="input is-small" type="password" name="confirm_password" placeholder="{{T "Profile.ConfirmPasswordPlaceholder"}}" required minlength="5">
                                    <span class="icon is-small is-left"><i class="fas fa-check"></i></span>
                                </div>
                            </div>

                            <hr class="my-3">

                            <div class="field is-grouped is-grouped-right">
                                <div class="control">
                                    <a href="/profile" class="button is-small is-light">
                                        <span class="icon is-small"><i class="fas fa-times"></i></span>
                                        <span>{{T "Common.Cancel"}}</span>
                                    </a>
                                </div>
                                <div class="control">
                                    <button type="submit" class="button is-small is-primary">
                                        <span class="icon is-small"><i class="fas fa-check"></i></span>
                                        <span>{{T "Profile.UpdatePassword"}}</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {{else}}
                <div class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <span class="icon has-text-warning mr-3" style="font-size: 1.75rem;">
                                <i class="fas fa-key"></i>
                            </span>
                            <div>
                                <p class="title is-6 mb-1">{{T "Profile.ChangePassword"}}</p>
                                <p class="is-size-7 has-text-grey">{{T "Profile.PasswordChangeDescription"}}</p>
                            </div>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <a href="/profile?show_password_form=1" class="button is-primary">
                                <span class="icon"><i class="fas fa-edit"></i></span>
                                <span>{{T "Profile.ChangePasswordButton"}}</span>
                            </a>
                        </div>
                    </div>
                </div>
                {{end}}
            </div>
        </div>
    </div>
</section>
{{end}}
