{{define "admin_nodes"}}
  {{template "admin_base" .}}
  <script>
    // Auto-refresh page every 30 seconds to check for node status changes
    setInterval(function() {
      window.location.reload();
    }, 30000);
  </script>
{{end}}

{{define "admin_nodes_section"}}
  <div class="container mt-4">
    {{if not .ProxmoxConnected}}
    {{template "notification" (dict 
      "Type" "warning" 
      "Title" (T "Proxmox.ConnectionRequired") 
      "Message" (printf "%s %s" (T "Proxmox.NotConnected") (T "Proxmox.CheckConnection")) 
      "Icon" "fas fa-exclamation-triangle" 
      "Dismissible" false 
      "Light" false 
      "ExtraClasses" "mb-5" 
      "Live" "assertive"
    )}}
    {{else if .Error}}
    {{template "notification" (dict 
      "Type" "danger" 
      "Title" (T "Common.Error") 
      "Message" .Error 
      "Icon" "fas fa-times-circle" 
      "Dismissible" true 
      "Light" false 
      "ExtraClasses" "mb-5" 
      "Live" "assertive"
    )}}
    {{else if .NodeDetails}}
    <div class="content mb-5">
      <h1 class="title is-4">
        <span class="icon"><i class="fas fa-server"></i></span>
        <span>{{T "Nodes.Title"}}</span>
      </h1>
      <p class="subtitle is-6 has-text-grey">{{T "Nodes.Description"}}</p>
    </div>
    
    <div class="columns is-multiline">
      {{range .NodeDetails}}
      <div class="column is-12-mobile is-6-tablet is-4-desktop">
        <div class="card node-card">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon mr-2"><i class="fas fa-server"></i></span>
              <span>{{.Node}}</span>
            </p>
            <div class="card-header-icon">
              {{if eq .Status "online"}}
              <span class="tag is-success">
                <span class="icon is-small"><i class="fas fa-circle"></i></span>
                <span class="ml-1">{{T "Nodes.Status.Online"}}</span>
              </span>
              {{else if eq .Status "offline"}}
              <span class="tag is-danger">
                <span class="icon is-small"><i class="fas fa-circle"></i></span>
                <span class="ml-1">{{T "Nodes.Status.Offline"}}</span>
              </span>
              {{else}}
              <span class="tag is-warning">
                <span class="icon is-small"><i class="fas fa-question-circle"></i></span>
                <span class="ml-1">{{.Status}}</span>
              </span>
              {{end}}
            </div>
          </header>
          
          <div class="card-content">
            {{if eq .Status "offline"}}
            <!-- Offline node message -->
            <div class="notification is-warning is-light">
              <span class="icon">
                <i class="fas fa-exclamation-triangle"></i>
              </span>
              <span>{{T "Nodes.OfflineMessage"}}</span>
            </div>
            
            <!-- Additional offline info -->
            <div class="has-text-centered is-size-7 has-text-grey">
              <span class="icon is-small"><i class="fas fa-info-circle"></i></span>
              <span>{{T "Nodes.OfflineInfo"}}</span>
            </div>
            {{else}}
            <!-- CPU Usage -->
            <div class="field mb-4">
              <label class="label is-small has-text-grey">
                <span class="icon is-small"><i class="fas fa-microchip"></i></span>
                <span>{{T "Nodes.Header.CPUUsage"}}</span>
              </label>
              
              {{$cpu_usage := .CPU}}
              {{$cpu_percent := mul $cpu_usage 100.0}}
              {{$used_cores := mul $cpu_usage .MaxCPU}}
              {{$max_cores := .MaxCPU}}
              
              <div class="control">
                <progress class="progress is-small {{if lt $cpu_percent 70.0}}is-success{{else if lt $cpu_percent 90.0}}is-warning{{else}}is-danger{{end}}" 
                  value="{{printf "%.0f" $cpu_percent}}" max="100" 
                  title="{{printf "%.1f%% CPU Usage"}}">
                </progress>
              </div>
              
              <div class="is-flex is-justify-content-space-between is-size-7">
                <span class="has-text-weight-bold">{{printf "%.1f%%" $cpu_percent}}</span>
              </div>
            </div>

            <!-- Memory Usage -->
            <div class="field mb-4">
              <label class="label is-small has-text-grey">
                <span class="icon is-small"><i class="fas fa-memory"></i></span>
                <span>{{T "Nodes.Header.MemoryUsage"}}</span>
              </label>
              
              {{$mem_percent := mul (div .Memory .MaxMemory) 100.0}}
              
              <div class="control">
                <progress class="progress is-small {{if lt $mem_percent 70.0}}is-success{{else if lt $mem_percent 90.0}}is-warning{{else}}is-danger{{end}}" 
                  value="{{printf "%.0f" $mem_percent}}" max="100">
                </progress>
              </div>
              
              <div class="is-flex is-justify-content-space-between is-size-7">
                <span>{{printf "%.0f" .Memory | humanBytes}} / {{printf "%.0f" .MaxMemory | humanBytes}}</span>
                <span class="has-text-weight-bold">{{printf "%.0f%%" $mem_percent}}</span>
              </div>
            </div>

            <!-- Disk Usage -->
            <div class="field">
              <label class="label is-small has-text-grey">
                <span class="icon is-small"><i class="fas fa-hdd"></i></span>
                <span>{{T "Nodes.Header.DiskUsage"}}</span>
              </label>
              
              {{$disk_percent := mul (div .Disk .MaxDisk) 100.0}}
              
              <div class="control">
                <progress class="progress is-small {{if lt $disk_percent 70.0}}is-success{{else if lt $disk_percent 90.0}}is-warning{{else}}is-danger{{end}}" 
                  value="{{printf "%.0f" $disk_percent}}" max="100">
                </progress>
              </div>
              
              <div class="is-flex is-justify-content-space-between is-size-7">
                <span>{{printf "%.0f" .Disk | humanBytes}} / {{printf "%.0f" .MaxDisk | humanBytes}}</span>
                <span class="has-text-weight-bold">{{printf "%.0f%%" $disk_percent}}</span>
              </div>
            </div>
            {{end}} <!-- End of offline check -->
          </div>
        </div>
      </div>
      {{end}}
    </div>
    {{else}}
    <div class="content has-text-centered">
      <p class="subtitle has-text-grey">{{T "Nodes.NoNodes"}}</p>
    </div>
    {{end}}
  </div>
{{end}}
