{{define "create_vm"}}
{{$lang := .Lang}}

<section class="section" aria-labelledby="main-title" role="main">
    <div class="container">
        <div class="columns is-centered">
            <div class="column is-10">
                <div class="card admin-card">
                    <header class="card-header brand-header is-align-items-center">
                        <p class="card-header-title">
                            <span class="icon"><i class="fas fa-plus-square"></i></span>&nbsp;{{T
                            "VM.Create.Title"}}
                        </p>
                    </header>
                    <div class="card-content">
                        <p class="mb-4 has-text-grey">{{T "UI.CreateVMDescription"}}</p>
                        {{if not .ProxmoxConnected}}
                        <div class="notification is-warning is-pulse mb-5" role="alert" aria-live="polite">
                            <div class="level is-mobile">
                                <div class="level-left">
                                    <div class="level-item">
                                        <span class="icon has-text-white">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                    </div>
                                    <div class="level-item">
                                        <div>
                                            <strong>{{T "Proxmox.ConnectionRequired" | default "Connection Required"}}</strong>
                                            <p>{{T "VM.Create.ProxmoxNotConnected" | default "Cannot create VM: Proxmox server is not connected."}}</p>
                                            {{if .ProxmoxError}}
                                            <p class="has-text-orange mt-2">{{.ProxmoxError}}</p>
                                            {{end}}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{end}}
                        <form method="POST" action="/api/vm/create" id="vmCreateForm"
                            aria-label="Create new virtual machine" {{if not .ProxmoxConnected}}onsubmit="return false;"
                            {{end}}>
                            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                            <fieldset {{if not .ProxmoxConnected}}disabled{{end}}
                                aria-disabled="{{if not .ProxmoxConnected}}true{{else}}false{{end}}">
                                <div class="columns is-multiline">
                                    {{/* Prepare limits helpers */}}
                                    {{$vm := index .Limits "vm"}}
                                    {{$vmSockMin := int (index (index $vm "sockets") "min")}}
                                    {{$vmSockMax := int (index (index $vm "sockets") "max")}}
                                    {{$vmCoreMin := int (index (index $vm "cores") "min")}}
                                    {{$vmCoreMax := int (index (index $vm "cores") "max")}}
                                    {{$vmRamMinGB := int (index (index $vm "ram") "min")}}
                                    {{$vmRamMaxGB := int (index (index $vm "ram") "max")}}
                                    {{$vmRamMinMB := int (mul $vmRamMinGB 1024)}}
                                    {{$vmRamMaxMB := int (mul $vmRamMaxGB 1024)}}
                                    {{$vmDiskMin := int (index (index $vm "disk") "min")}}
                                    {{$vmDiskMax := int (index (index $vm "disk") "max")}}
                                    {{/* Node limits map for later inline lookups */}}
                                    {{$nodesLimits := index .Limits "nodes"}}
                                    <!-- Left Column -->
                                    <div class="column is-6">
                                        <!-- Basic Information -->
                                        <div class="box mb-5" role="region" aria-labelledby="basic-info-heading">
                                            <h2 id="basic-info-heading" class="title is-5">{{T
                                                "VM.Create.BasicInfo"}}</h2>
                                            <!-- VM Name -->
                                            <div class="field">
                                                <label for="vmName" class="label">
                                                    <span class="icon-text">
                                                        <span class="icon"><i class="fas fa-tag"></i></span>
                                                        <span>{{T "Common.Name"}}</span>
                                                    </span>
                                                </label>
                                                <div class="control">
                                                    <input id="vmName" class="input" type="text" name="name"
                                                        placeholder='{{T "VM.Create.VMNamePlaceholder"}}'
                                                        required aria-required="true" aria-describedby="nameHelp">
                                                    <p id="nameHelp" class="help">{{T "VM.Create.VMNameHelp"}}
                                                    </p>
                                                </div>
                                            </div>
                                            <!-- Description -->
                                            <div class="field">
                                                <label for="vmDescription" class="label">{{T
                                                    "VM.Create.Description"}}</label>
                                                <div class="control">
                                                    <textarea id="vmDescription" class="textarea" name="description"
                                                        placeholder='{{T "VM.Create.DescriptionPlaceholder"}}'
                                                        rows="2" aria-describedby="descHelp"></textarea>
                                                    <p id="descHelp" class="help is-hidden" aria-hidden="true">Optional
                                                        description for your virtual machine</p>
                                                </div>
                                            </div>
                                            <!-- VM ID -->
                                            <div class="field">
                                                <label for="vmId" class="label">
                                                    {{T "VM.Create.VMID"}}
                                                </label>
                                                <div class="control">
                                                    <input id="vmId" class="input" type="number" name="vmid" min="100"
                                                        max="999999999"
                                                        placeholder='{{T "VM.Create.VMIDPlaceholder"}}'
                                                        aria-describedby="vmidHelp">
                                                    <p id="vmidHelp" class="help">{{T "VM.Create.VMID.Help"}}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Resources -->
                                        <div class="box mb-5" role="region" aria-labelledby="resources-heading">
                                            <h2 id="resources-heading" class="title is-5">{{T
                                                "VM.Create.Resources"}}</h2>
                                            <div class="columns">
                                                <!-- CPU Sockets -->
                                                <div class="column is-6">
                                                    <div class="field">
                                                        <label for="cpuSockets" class="label">
                                                            <span class="icon-text">
                                                                <span class="icon"><i
                                                                        class="fas fa-microchip"></i></span>
                                                                <span>{{T "VM.Create.CPUSockets"}}</span>
                                                            </span>
                                                        </label>
                                                        <div class="control">
                                                            <div class="select is-fullwidth">
                                                                <select id="cpuSockets" name="sockets" required
                                                                    aria-required="true">
                                                                    {{/* Limit sockets to configured min..max inclusive
                                                                    */}}
                                                                    {{range $i := seq $vmSockMin (int (add $vmSockMax
                                                                    1))}}
                                                                    <option value="{{$i}}" {{if eq $i
                                                                        $vmSockMin}}selected{{end}}>{{$i}}</option>
                                                                    {{end}}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <p class="help">
                                                            VM limits: {{$vmSockMin}}–{{$vmSockMax}}
                                                        </p>
                                                    </div>
                                                </div>

                                                <!-- CPU Cores -->
                                                <div class="column is-6">
                                                    <div class="field">
                                                        <label for="cpuCores" class="label">{{T
                                                            "VM.Create.CPUCores"}}</label>
                                                        <div class="control">
                                                            <div class="select is-fullwidth">
                                                                <select id="cpuCores" name="cores" required
                                                                    aria-required="true">
                                                                    {{/* Limit cores to configured min..max inclusive
                                                                    */}}
                                                                    {{range $i := seq $vmCoreMin (int (add $vmCoreMax
                                                                    1))}}
                                                                    <option value="{{$i}}" {{if eq $i
                                                                        $vmCoreMin}}selected{{end}}>{{$i}}</option>
                                                                    {{end}}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <p class="help">
                                                            VM limits: {{$vmCoreMin}}–{{$vmCoreMax}}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Memory -->
                                            <div class="field">
                                                <label for="memory" class="label">{{T "Common.Memory"}}</label>
                                                <div class="field has-addons">
                                                    <div class="control is-expanded">
                                                        <input id="memory" class="input" type="number" name="memory"
                                                            min="{{$vmRamMinMB}}" max="{{$vmRamMaxMB}}" step="128"
                                                            value="{{$vmRamMinMB}}" required aria-required="true">
                                                    </div>
                                                    <div class="control">
                                                        <span class="button is-static" aria-hidden="true">MB</span>
                                                    </div>
                                                </div>
                                                <p class="help">
                                                    {{T "VM.Create.MemoryHelp"}}<br>
                                                    VM limits: {{$vmRamMinGB}}–{{$vmRamMaxGB}} GB
                                                    ({{$vmRamMinMB}}–{{$vmRamMaxMB}} MB)
                                                </p>
                                            </div>

                                            <!-- Disk Size -->
                                            <div class="field">
                                                <label for="diskSize" class="label">{{T
                                                    "VM.Create.DiskSize"}}</label>
                                                <div class="field has-addons">
                                                    <div class="control is-expanded">
                                                        <input id="diskSize" class="input" type="number"
                                                            name="disk_size" min="{{$vmDiskMin}}" max="{{$vmDiskMax}}"
                                                            step="1" value="{{$vmDiskMax}}" required
                                                            aria-required="true">
                                                    </div>
                                                    <div class="control">
                                                        <span class="button is-static" aria-hidden="true">GB</span>
                                                    </div>
                                                </div>
                                                <p class="help">
                                                    {{T "VM.Create.DiskSizeHelp"}}<br>
                                                    VM limits: {{$vmDiskMin}}–{{$vmDiskMax}} GB
                                                </p>
                                            </div>
                                        </div>
                                    </div> <!-- End Left Column -->

                                    <!-- Right Column -->
                                    <div class="column is-6">
                                        <!-- Media & Network -->
                                        <div class="box mb-5" role="region" aria-labelledby="media-heading">
                                            <h2 id="media-heading" class="title is-5">{{T
                                                "VM.Create.MediaNetwork"}}</h2>

                                            <!-- Node Selector -->
                                            <div class="field">
                                                <label for="node" class="label">
                                                    <span class="icon-text">
                                                        <span class="icon"><i class="fas fa-server"></i></span>
                                                        <span>Node</span>
                                                    </span>
                                                </label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select id="node" name="node" required aria-required="true">
                                                            {{range .Nodes}}
                                                            <option value="{{.}}" {{if eq .
                                                                $.ActiveNode}}selected{{end}}>{{.}}</option>
                                                            {{else}}
                                                            <option disabled>No nodes available</option>
                                                            {{end}}
                                                        </select>
                                                    </div>
                                                    <p class="help">Select the target Proxmox node</p>
                                                </div>
                                            </div>

                                            <!-- Pool (optional) -->
                                            <div class="field">
                                                <label for="pool" class="label">
                                                    <span class="icon-text">
                                                        <span class="icon"><i class="fas fa-layer-group"></i></span>
                                                        <span>Pool</span>
                                                    </span>
                                                </label>
                                                <div class="control">
                                                    <input id="pool" class="input" type="text" name="pool" value="{{.DefaultPool}}" placeholder="pvmss_<user>" aria-describedby="poolHelp">
                                                </div>
                                                <p id="poolHelp" class="help">Optional: assign the VM to a Proxmox pool (requires ACL)</p>
                                            </div>

                                            <!-- ISO Image -->
                                            <div class="field">
                                                <label for="isoImage" class="label">
                                                    <span class="icon-text">
                                                        <span class="icon"><i class="fas fa-compact-disc"></i></span>
                                                        <span>{{T "VM.Create.ISOImage"}}</span>
                                                    </span>
                                                </label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select id="isoImage" name="iso" aria-describedby="isoHelp">
                                                            <option value="">-- {{T "VM.Create.SelectISO"}} --
                                                            </option>
                                                            {{range .ISOs}}
                                                            <option value="{{.}}">{{.}}</option>
                                                            {{else}}
                                                            <option disabled>{{T "VM.Create.NoISOsAvailable"}}
                                                            </option>
                                                            {{end}}
                                                        </select>
                                                    </div>
                                                    <p id="isoHelp" class="help">{{T "VM.Create.ISOImageHelp"}}
                                                    </p>
                                                </div>
                                            </div>

                                            <!-- Network Bridge -->
                                            <div class="field">
                                                <label for="networkBridge" class="label">{{T
                                                    "VM.Create.Network"}}</label>
                                                <div class="control">
                                                    <div class="select is-fullwidth">
                                                        <select id="networkBridge" name="bridge" required
                                                            aria-required="true">
                                                            {{range .Bridges}}
                                                            <option value="{{.}}" {{if eq . "vmbr0" }}selected{{end}}>
                                                                {{.}}</option>
                                                            {{else}}
                                                            <option disabled>{{T "VM.Create.NoBridgesAvailable"}}
                                                            </option>
                                                            {{end}}
                                                        </select>
                                                    </div>
                                                    <p class="help">{{T "VM.Create.NetworkBridgeHelp"}}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Tags Section -->
                                        <div class="tags-section">
                                            <div class="field">
                                                <div class="tags-label">
                                                    <span class="icon"><i class="fas fa-tags"></i></span>
                                                    <span>{{T "VM.Create.Tags"}}</span>
                                                </div>

                                                <!-- Selected Tags (for visual feedback) -->
                                                <div class="selected-tags mb-4">
                                                    {{if $.FormData.Tags}}
                                                    {{range $tag := $.FormData.Tags}}
                                                    <span class="tag is-primary is-medium">{{$tag}}</span>
                                                    {{end}}
                                                    {{else}}
                                                    <span class="has-text-grey">No tags selected</span>
                                                    {{end}}
                                                </div>

                                                <!-- Available Tags as Checkboxes -->
                                                <div class="tags-options">
                                                    {{range $tag := .AvailableTags}}
                                                    {{if eq $tag "pvmss"}}
                                                    <label class="tag-option checkbox-label" title="Mandatory tag">
                                                        <input type="checkbox" name="tags" value="pvmss" checked disabled aria-disabled="true" class="visually-hidden-checkbox">
                                                        <span class="tag is-primary">pvmss</span>
                                                        <!-- Ensure value is submitted since the checkbox is disabled -->
                                                        <input type="hidden" name="tags" value="pvmss">
                                                    </label>
                                                    {{else}}
                                                    <label class="tag-option checkbox-label">
                                                        <input type="checkbox" name="tags" value="{{$tag}}" {{if contains $tag $.FormData.Tags}}checked{{end}} class="visually-hidden-checkbox">
                                                        <span class="tag is-light">{{$tag}}</span>
                                                    </label>
                                                    {{end}}
                                                    {{else}}
                                                    <p class="has-text-grey">{{T "VM.Create.NoTagsAvailable"}}
                                                    </p>
                                                    {{end}}
                                                </div>
                                                <p class="help">{{T "VM.Create.TagsHelp"}}</p>
                                            </div>
                                        </div>

                                        <!-- Form Actions -->
                                        <div class="box" role="region">
                                            <div class="field is-grouped is-justify-content-flex-end">
                                                <div class="control">
                                                    <button type="reset" class="button is-light is-fullwidth">
                                                        <span class="icon"><i class="fas fa-undo"></i></span>
                                                        <span>{{T "Common.Reset"}}</span>
                                                    </button>
                                                </div>
                                                <div class="control">
                                                    <button type="submit" class="button is-primary is-fullwidth">
                                                        <span class="icon"><i class="fas fa-save"></i></span>
                                                        <span>{{T "Common.Create"}}</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{{end}}