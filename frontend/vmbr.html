{{define "vmbr"}}
<div class="container">
    <h2 class="title is-4">{{index .t "Admin.VMBR.Title"}}</h2>

    <div class="notification is-light">
        {{index .t "Admin.VMBR.Description"}}
    </div>

    <div id="vmbr-container" class="mb-4">
        <!-- VMBR content will be loaded here -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if this component has already been initialized
    if (window.vmbrInitialized) return;
    window.vmbrInitialized = true;
    
    const vmbrContainer = document.getElementById('vmbr-container');

    let savedVmbrs = [];
    fetch('/api/settings')
        .then(response => response.json())
        .then(settings => {
            savedVmbrs = settings.vmbrs || [];
            return fetch('/api/vmbr/all');
        })
        .then(response => response.json())
        .then(data => {
            vmbrContainer.innerHTML = ''; // Clear any previous content
            if (data.vmbrs && data.vmbrs.length > 0) {
                // Create table element
                const table = document.createElement('table');
                table.className = 'table is-fullwidth is-striped';
                
                // Create table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>{{index .t "Admin.VMBR.Header.Enabled"}}</th>
                        <th>{{index .t "Admin.VMBR.Header.Node"}}</th>
                        <th>{{index .t "Admin.VMBR.Header.Name"}}</th>
                        <th>{{index .t "Admin.VMBR.Header.Description"}}</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                data.vmbrs.forEach(vmbr => {
                    const row = document.createElement('tr');
                    
                    // Enabled cell with checkbox
                    const enabledCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'vmbr-checkbox';
                    checkbox.dataset.name = vmbr.name;
                    if (savedVmbrs.includes(vmbr.name)) {
                        checkbox.checked = true;
                    }
                    enabledCell.appendChild(checkbox);
                    row.appendChild(enabledCell);
                    
                    // Node cell
                    const nodeCell = document.createElement('td');
                    nodeCell.textContent = vmbr.node;
                    row.appendChild(nodeCell);
                    
                    // Name cell
                    const nameCell = document.createElement('td');
                    nameCell.textContent = vmbr.name;
                    row.appendChild(nameCell);
                    
                    // Description cell
                    const descriptionCell = document.createElement('td');
                    descriptionCell.textContent = vmbr.description;
                    row.appendChild(descriptionCell);
                    
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                vmbrContainer.appendChild(table);
            } else {
                vmbrContainer.innerHTML = '<div class="notification is-warning">{{index . "Admin.VMBR.NoVMBRs"}}</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            vmbrContainer.innerHTML = '<div class="notification is-danger">{{index . "Admin.VMBR.Error"}}</div>';
        });

    function saveVmbrSelections() {
        const selectedVmbrs = [];
        document.querySelectorAll('.vmbr-checkbox:checked').forEach(checkbox => {
            selectedVmbrs.push(checkbox.dataset.name);
        });

        fetch('/api/vmbr/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ vmbrs: selectedVmbrs })
        })
        .then(response => {
            if (!response.ok) {
                console.error('Failed to save VMBR selections.');
            }
        })
        .catch(error => {
            console.error('Error saving VMBRs:', error);
        });
    }

    vmbrContainer.addEventListener('change', function(event) {
        if (event.target.matches('.vmbr-checkbox')) {
            saveVmbrSelections();
        }
    });
});
</script>
{{end}}
