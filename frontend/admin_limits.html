{{define "admin_limits"}}
  {{template "admin_base" .}}
{{end}}

{{define "admin_limits_section"}}
<div class="container mt-4">
  <div class="content mb-5">
    <h1 class="title is-4">
      <span class="icon"><i class="fas fa-sliders-h"></i></span>
      <span>{{T "Admin.Limits.Title"}}</span>
    </h1>
    <p class="subtitle is-6 has-text-grey">{{T "Admin.Limits.Description"}}</p>
  </div>

  <!-- Success/Error notifications -->
  {{if .Success}}
  {{template "notification" (dict 
    "Type" "success" 
    "Message" .SuccessMessage 
    "Icon" "fas fa-check" 
    "Dismissible" true
  )}}
  {{end}}

  {{if .Error}}
  {{template "notification" (dict 
    "Type" "danger" 
    "Title" (T "Common.Error")
    "Message" .ErrorMessage 
    "Icon" "fas fa-exclamation-triangle" 
    "Dismissible" true
  )}}
  {{end}}

  <!-- Node Limits Section (Priority - Configure cluster-wide limits first) -->
  {{if .ProxmoxConnected}}
  <div class="box admin-box">
    <form action="/admin/limits/update" method="POST">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <input type="hidden" name="entityId" value="node">

      {{if .Node}}
      <input type="hidden" name="nodeName" value="{{.Node}}">
      <div class="mb-5">
        <h2 class="title is-5 mb-2">
          <span class="icon"><i class="fas fa-server"></i></span>
          <span>{{T "Admin.Limits.Node"}}: <span class="has-text-primary">{{.Node}}</span></span>
        </h2>
        <p class="subtitle is-6 has-text-grey">{{T "Admin.Limits.AggregateScopeNode"}}</p>
      </div>
      {{else}}
      <div class="mb-5">
        <h2 class="title is-5 has-text-danger mb-2">
          <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
          <span>{{T "Admin.Limits.NoNodeSelected"}}</span>
        </h2>
      </div>
      {{template "notification" (dict 
        "Type" "warning" 
        "Title" (T "Admin.Limits.NoNodeSelected") 
        "MessageHTML" (T "Admin.Limits.SelectNodePrompt") 
        "Icon" "fas fa-exclamation-triangle" 
        "Dismissible" false 
        "Light" true 
        "ExtraClasses" "mb-4"
      )}}
      <div class="field has-addons">
        <div class="control is-expanded">
          <div class="select is-fullwidth">
            <select id="nodeSelect" name="node">
              <option value="">{{T "Admin.Limits.SelectNode"}}</option>
              {{range $node := .NodeNames}}
              <option value="{{$node}}">{{$node}}</option>
              {{end}}
            </select>
          </div>
        </div>
        <div class="control">
          <button class="button is-primary" type="button"
                  onclick="if(document.getElementById('nodeSelect').value) window.location.href='/admin/limits?node=' + encodeURIComponent(document.getElementById('nodeSelect').value)">
            <span class="icon"><i class="fas fa-check"></i></span>
            <span>{{T "Common.Select"}}</span>
          </button>
        </div>
      </div>
      {{end}}

      {{if .Node}}
        {{if .NodeCapacities}}
          {{$capacity := index .NodeCapacities .Node}}
          {{if $capacity}}
          <!-- Node Physical Capacity -->
          {{template "notification" (dict 
            "Type" "info" 
            "Title" (T "Admin.Limits.NodePhysicalCapacity") 
            "MessageHTML" (printf "<p class=\"mb-1\"><strong>%s</strong> %d CPUs</p><p class=\"mb-1\"><strong>%s</strong> %d GB</p><p class=\"is-size-7 has-text-grey mt-2\">%s</p>" 
              (T "Admin.Limits.AggregateCores") $capacity.CPUs 
              (T "Admin.Limits.AggregateMemory") $capacity.MemoryGB 
              (T "Admin.Limits.CapacityWarning"))
            "Icon" "fas fa-server" 
            "Dismissible" false 
            "Light" true 
            "ExtraClasses" "mb-5"
          )}}
          {{end}}
        {{end}}
      {{end}}

      {{if .Node}}
        {{if .NodeUsage}}
          {{$usage := index .NodeUsage .Node}}
          {{if $usage}}
          <!-- Resource Usage Display -->
          <div class="box has-background-info-light mb-5">
            <p class="has-text-weight-bold mb-3">
              <span class="icon"><i class="fas fa-chart-bar"></i></span>
              <span>{{T "Admin.Limits.AggregateTitle"}}</span>
            </p>
            <div class="content is-small">
              <p class="mb-3 has-text-grey-dark">
                <span class="icon is-small"><i class="fas fa-server"></i></span>
                <strong>{{$usage.TotalVMs}}</strong> {{T "Admin.Limits.AggregateTotalVMs"}}
              </p>
              
              <!-- Cores Usage -->
              <div class="mb-3">
                <div class="is-flex is-justify-content-space-between mb-1">
                  <span><strong>{{T "Admin.Limits.AggregateCores"}}</strong></span>
                  <span>
                    {{if gt $usage.MaxCores 0}}
                      <strong>{{$usage.Cores}}</strong> / {{$usage.MaxCores}}
                    {{else}}
                      <strong>{{$usage.Cores}}</strong> <span class="tag is-warning is-light is-small">{{T "Admin.Limits.AggregateNoLimit"}}</span>
                    {{end}}
                  </span>
                </div>
                {{if gt $usage.MaxCores 0}}
                  {{$coresPercent := div (mul $usage.Cores 100) $usage.MaxCores}}
                  <progress class="progress {{if ge (mul $usage.Cores 100) (mul $usage.MaxCores 90)}}is-danger{{else if ge (mul $usage.Cores 100) (mul $usage.MaxCores 75)}}is-warning{{else}}is-success{{end}}" 
                            value="{{$usage.Cores}}" max="{{$usage.MaxCores}}">{{$coresPercent}}%</progress>
                {{end}}
              </div>
              
              <!-- RAM Usage -->
              <div class="mb-2">
                <div class="is-flex is-justify-content-space-between mb-1">
                  <span><strong>{{T "Admin.Limits.AggregateMemory"}}</strong></span>
                  <span>
                    {{if gt $usage.MaxRamGB 0}}
                      <strong>{{$usage.RamGB}} GB</strong> / {{$usage.MaxRamGB}} GB
                    {{else}}
                      <strong>{{$usage.RamGB}} GB</strong> <span class="tag is-warning is-light is-small">{{T "Admin.Limits.AggregateNoLimit"}}</span>
                    {{end}}
                  </span>
                </div>
                {{if gt $usage.MaxRamGB 0}}
                  {{$ramPercent := div (mul $usage.RamGB 100) $usage.MaxRamGB}}
                  <progress class="progress {{if ge (mul $usage.RamGB 100) (mul $usage.MaxRamGB 90)}}is-danger{{else if ge (mul $usage.RamGB 100) (mul $usage.MaxRamGB 75)}}is-warning{{else}}is-success{{end}}" 
                            value="{{$usage.RamGB}}" max="{{$usage.MaxRamGB}}">{{$ramPercent}}%</progress>
                {{end}}
              </div>
              
              <hr class="my-2">
              <p class="is-size-7 has-text-grey">
                <span class="icon is-small"><i class="fas fa-info-circle"></i></span>
                {{T "Admin.Limits.AggregateDescription"}}
              </p>
            </div>
          </div>
          {{end}}
        {{end}}
      {{end}}

      <!-- Node Cores Limit -->
      <div class="field mb-5">
        <label class="label">
          <span class="icon"><i class="fas fa-microchip"></i></span>
          <span>{{T "Admin.Limits.TotalCores"}}</span>
        </label>
        <div class="control">
          <input class="input" type="number" name="cores-max"
                 value="{{if .Node}}{{if .Limits}}{{if index .Limits "nodes"}}{{if index (index .Limits "nodes") .Node}}{{if index (index (index .Limits "nodes") .Node) "cores"}}{{index (index (index (index .Limits "nodes") .Node) "cores") "max"}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}"
                 min="1" step="1" placeholder="{{T "Common.Max"}}"{{if not .Node}} disabled{{end}}>
        </div>
        <p class="help">{{T "Admin.Limits.MinAlways1"}}</p>
      </div>

      <!-- Node RAM Limit -->
      <div class="field mb-5">
        <label class="label">
          <span class="icon"><i class="fas fa-memory"></i></span>
          <span>{{T "Admin.Limits.TotalMemory"}}</span>
        </label>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input" type="number" name="ram-min"
                   value="{{if .Node}}{{if .Limits}}{{if index .Limits "nodes"}}{{if index (index .Limits "nodes") .Node}}{{if index (index (index .Limits "nodes") .Node) "ram"}}{{index (index (index (index .Limits "nodes") .Node) "ram") "min"}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}"
                   min="1" step="1" placeholder="{{T "Common.Min"}}"{{if not .Node}} disabled{{end}}>
          </div>
          <div class="control">
            <span class="button is-static">-</span>
          </div>
          <div class="control is-expanded">
            <input class="input" type="number" name="ram-max"
                   value="{{if .Node}}{{if .Limits}}{{if index .Limits "nodes"}}{{if index (index .Limits "nodes") .Node}}{{if index (index (index .Limits "nodes") .Node) "ram"}}{{index (index (index (index .Limits "nodes") .Node) "ram") "max"}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}"
                   min="1" step="1" placeholder="{{T "Common.Max"}}"{{if not .Node}} disabled{{end}}>
          </div>
          <div class="control">
            <span class="button is-static">{{T "Admin.Limits.GB"}}</span>
          </div>
        </div>
      </div>

      <div class="field is-grouped is-grouped-right mt-6">
        <div class="control">
          <button type="reset" class="button is-light is-outlined"{{if not .Node}} disabled{{end}}>
            <span>{{T "Common.Reset"}}</span>
          </button>
        </div>
        <div class="control">
          <button type="submit" class="button is-primary has-text-white"{{if not .Node}} disabled{{end}}>
            <span class="icon"><i class="fas fa-save"></i></span>
            <span>{{T "Common.Save"}}</span>
          </button>
        </div>
      </div>
    </form>
  </div>
  {{else}}
  <div class="box admin-box">
    {{template "notification" (dict 
      "Type" "warning" 
      "Title" (T "Proxmox.ConnectionErrorTitle")
      "Message" (T "Proxmox.ConnectionRequired") 
      "Icon" "fas fa-exclamation-triangle" 
      "Dismissible" false
    )}}
  </div>
  {{end}}

  <!-- VM Limits Section (Individual VM Configuration) -->
  <div class="box admin-box mt-5">
    <form action="/admin/limits/update" method="POST">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <input type="hidden" name="entityId" value="vm">
      
      <div class="mb-5">
        <h2 class="title is-5 mb-2">
          <span class="icon"><i class="fas fa-desktop"></i></span>
          <span>{{T "Admin.Limits.VM"}}</span>
        </h2>
        <p class="subtitle is-6 has-text-grey">{{T "Admin.Limits.ScopeVM"}}</p>
      </div>

      <!-- Sockets -->
      <div class="field mb-5">
        <label class="label">
          <span class="icon"><i class="fas fa-microchip"></i></span>
          <span>{{T "Admin.Limits.Sockets"}}</span>
        </label>
        <div class="control">
          <input class="input" type="number" name="sockets-max"
                 value="{{if .Limits}}{{if index .Limits "vm"}}{{if index (index .Limits "vm") "sockets"}}{{index (index (index .Limits "vm") "sockets") "max"}}{{else}}2{{end}}{{else}}2{{end}}{{else}}2{{end}}"
                 min="1" step="1" placeholder="{{T "Common.Max"}}">
        </div>
        <p class="help">{{T "Admin.Limits.MinAlways1"}}</p>
      </div>

      <!-- Cores -->
      <div class="field mb-5">
        <label class="label">
          <span class="icon"><i class="fas fa-microchip"></i></span>
          <span>{{T "Admin.Limits.Cores"}}</span>
        </label>
        <div class="control">
          <input class="input" type="number" name="cores-max"
                 value="{{if .Limits}}{{if index .Limits "vm"}}{{if index (index .Limits "vm") "cores"}}{{index (index (index .Limits "vm") "cores") "max"}}{{else}}32{{end}}{{else}}32{{end}}{{else}}32{{end}}"
                 min="1" step="1" placeholder="{{T "Common.Max"}}">
        </div>
        <p class="help">{{T "Admin.Limits.MinAlways1"}}</p>
      </div>

      <!-- RAM -->
      <div class="field mb-5">
        <label class="label">
          <span class="icon"><i class="fas fa-memory"></i></span>
          <span>{{T "Admin.Limits.Memory"}}</span>
        </label>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input" type="number" name="ram-min"
                   value="{{if .Limits}}{{if index .Limits "vm"}}{{if index (index .Limits "vm") "ram"}}{{index (index (index .Limits "vm") "ram") "min"}}{{else}}1{{end}}{{else}}1{{end}}{{else}}1{{end}}"
                   min="1" step="1" placeholder="{{T "Common.Min"}}">
          </div>
          <div class="control">
            <span class="button is-static">-</span>
          </div>
          <div class="control is-expanded">
            <input class="input" type="number" name="ram-max"
                   value="{{if .Limits}}{{if index .Limits "vm"}}{{if index (index .Limits "vm") "ram"}}{{index (index (index .Limits "vm") "ram") "max"}}{{else}}64{{end}}{{else}}64{{end}}{{else}}64{{end}}"
                   min="1" step="1" placeholder="{{T "Common.Max"}}">
          </div>
          <div class="control">
            <span class="button is-static">{{T "Admin.Limits.GB"}}</span>
          </div>
        </div>
      </div>

      <!-- Disk -->
      <div class="field mb-5">
        <label class="label">
          <span class="icon"><i class="fas fa-hdd"></i></span>
          <span>{{T "Admin.Limits.Disk"}}</span>
        </label>
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input" type="number" name="disk-min"
                   value="{{if .Limits}}{{if index .Limits "vm"}}{{if index (index .Limits "vm") "disk"}}{{index (index (index .Limits "vm") "disk") "min"}}{{else}}10{{end}}{{else}}10{{end}}{{else}}10{{end}}"
                   min="1" step="1" placeholder="{{T "Common.Min"}}">
          </div>
          <div class="control">
            <span class="button is-static">-</span>
          </div>
          <div class="control is-expanded">
            <input class="input" type="number" name="disk-max"
                   value="{{if .Limits}}{{if index .Limits "vm"}}{{if index (index .Limits "vm") "disk"}}{{index (index (index .Limits "vm") "disk") "max"}}{{else}}500{{end}}{{else}}500{{end}}{{else}}500{{end}}"
                   min="1" step="1" placeholder="{{T "Common.Max"}}">
          </div>
          <div class="control">
            <span class="button is-static">{{T "Admin.Limits.GB"}}</span>
          </div>
        </div>
      </div>

      <div class="field is-grouped is-grouped-right mt-6">
        <div class="control">
          <button type="reset" class="button is-light is-outlined">
            <span>{{T "Common.Reset"}}</span>
          </button>
        </div>
        <div class="control">
          <button type="submit" class="button is-primary has-text-white">
            <span class="icon"><i class="fas fa-save"></i></span>
            <span>{{T "Common.Save"}}</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{{end}}
