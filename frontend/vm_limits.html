{{define "vm_limits.html"}}
<div class="container">
    <h2 class="title is-4">{{.LimitsTitle}}</h2>
    <div class="notification is-light"></div>
    <p class="subtitle">{{.LimitsDescription}}</p>

    <form id="limits-form" method="post">
        <div class="card mb-5">
            <header class="card-header">
                <p class="card-header-title">
                    <span>{{.LimitsVMDefaults}}</span>
                </p>
            </header>
            <div class="card-content">
                <div class="content">
                    <!-- Sockets -->
                    <div class="field">
                        <label class="label">
                            <span>{{.LimitsSockets}}</span>
                        </label>
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <input class="input" type="number" name="sockets_min" value="1" min="1" required>
                                <p class="help">{{.LimitsMin}}</p>
                            </div>
                            <div class="control is-expanded">
                                <input class="input" type="number" name="sockets_max" value="{{.VMLimits.Sockets.Max}}" min="1" required>
                                <p class="help">{{.LimitsMax}}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Cores -->
                    <div class="field">
                        <label class="label">
                            <span>{{.LimitsCores}}</span>
                        </label>
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <input class="input" type="number" name="cores_min" value="1" min="1" required>
                                <p class="help">{{.LimitsMin}}</p>
                            </div>
                            <div class="control is-expanded">
                                <input class="input" type="number" name="cores_max" value="{{.VMLimits.Cores.Max}}" min="1" required>
                                <p class="help">{{.LimitsMax}}</p>
                            </div>
                        </div>
                    </div>

                    <!-- RAM -->
                    <div class="field">
                        <label class="label">
                            <span>{{.LimitsMemory}} ({{.LimitsGB}})</span>
                        </label>
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <input class="input" type="number" name="ram_min" value="{{.VMLimits.RAM.Min}}" min="1" required>
                                <p class="help">{{.LimitsMin}}</p>
                            </div>
                            <div class="control is-expanded">
                                <input class="input" type="number" name="ram_max" value="{{.VMLimits.RAM.Max}}" min="1" required>
                                <p class="help">{{.LimitsMax}}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Disk -->
                    <div class="field">
                        <label class="label">
                            <span>{{.LimitsDisk}} ({{.LimitsGB}})</span>
                        </label>
                        <div class="field is-grouped">
                            <div class="control is-expanded">
                                <input class="input" type="number" name="disk_min" value="{{.VMLimits.Disk.Min}}" min="1" required>
                                <p class="help">{{.LimitsMin}}</p>
                            </div>
                            <div class="control is-expanded">
                                <input class="input" type="number" name="disk_max" value="{{.VMLimits.Disk.Max}}" min="1" required>
                                <p class="help">{{.LimitsMax}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="field is-grouped">
            <div class="control">
                <button type="submit" class="button is-primary">{{.LimitsSaveButton}}</button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('limits-form');
    const notificationContainer = document.createElement('div');
    notificationContainer.id = 'notification-container';
    document.body.appendChild(notificationContainer);

    // Function to fetch current limits
    const fetchLimits = async () => {
        try {
            const response = await fetch('/api/limits');
            if (!response.ok) {
                throw new Error('Failed to fetch limits');
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching limits:', error);
            showNotification('Error loading limits: ' + error.message, 'is-danger');
            return null;
        }
    };

    // Function to populate form
    const populateForm = (limits) => {
        if (!limits || !limits.vm) return;
        
        const vm = limits.vm;
        form.elements.sockets_min.value = vm.sockets.min || 1;
        form.elements.sockets_max.value = vm.sockets.max || 1;
        form.elements.cores_min.value = vm.cores.min || 1;
        form.elements.cores_max.value = vm.cores.max || 1;
        form.elements.ram_min.value = vm.ram.min || 1;
        form.elements.ram_max.value = vm.ram.max || 1;
        form.elements.disk_min.value = vm.disk.min || 1;
        form.elements.disk_max.value = vm.disk.max || 1;
    };

    // Show notification function
    const showNotification = (message, type) => {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<button class="delete"></button>${message}`;
        
        notificationContainer.appendChild(notification);

        const deleteButton = notification.querySelector('.delete');
        deleteButton.addEventListener('click', () => {
            notification.remove();
        });

        setTimeout(() => {
            if (notification.parentNode === notificationContainer) {
                notification.remove();
            }
        }, 5000);
    };

    if (form) {
        // Initialize form with current limits
        fetchLimits().then(populateForm);

        // Handle form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(form);
            const data = {
                vm: {
                    sockets: { 
                        min: parseInt(formData.get('sockets_min'), 10),
                        max: parseInt(formData.get('sockets_max'), 10)
                    },
                    cores: { 
                        min: parseInt(formData.get('cores_min'), 10),
                        max: parseInt(formData.get('cores_max'), 10)
                    },
                    ram: { 
                        min: parseInt(formData.get('ram_min'), 10),
                        max: parseInt(formData.get('ram_max'), 10)
                    },
                    disk: { 
                        min: parseInt(formData.get('disk_min'), 10),
                        max: parseInt(formData.get('disk_max'), 10)
                    }
                }
            };

            // Basic validation
            let isValid = true;
            document.querySelectorAll('input[type="number"]').forEach(input => {
                if (!input.checkValidity()) {
                    isValid = false;
                    input.classList.add('is-danger');
                } else {
                    input.classList.remove('is-danger');
                }
            });

            if (!isValid) {
                showNotification('{{.LimitsSaveError}}', 'is-danger');
                return;
            }

            try {
                const response = await fetch('/api/limits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    showNotification('{{.LimitsSaveSuccess}}', 'is-success');
                } else {
                    const errorText = await response.text();
                    showNotification(`{{.LimitsSaveError}}: ${errorText}`, 'is-danger');
                }
            } catch (error) {
                console.error('Error saving limits:', error);
                showNotification(`{{.LimitsSaveError}}: ${error.message}`, 'is-danger');
            }
        });
    }
});
</script>
{{end}}
