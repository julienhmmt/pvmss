{{define "admin_tags"}}
  {{template "admin_base" .}}
{{end}}

{{define "admin_tags_section"}}
<section class="section">
  <div class="container mt-4">

  <div class="content mb-5">
    <h1 class="title is-4"><span class="icon"><i class="fas fa-tags"></i></span>&nbsp;{{T "Admin.Tags.Title"}}</h1>
    <p class="subtitle is-6 has-text-grey">{{T "Admin.Tags.Description"}}</p>
  </div>

  <div class="box admin-box">
    <form method="POST" action="/tags" class="mb-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <div class="field has-addons">
        <div class="control is-expanded">
          <input type="text" id="new-tag" name="tag" class="input" maxlength="50" 
                 placeholder='{{T "Admin.Tags.NewTagPlaceholder"}}' required pattern="[a-zA-Z0-9_-]+" 
                 title="Only letters, numbers, hyphens, and underscores allowed">
        </div>
        <div class="control">
          <button type="submit" class="button is-primary">
            <span class="icon"><i class="fas fa-plus"></i></span>
            <span>{{T "Admin.Tags.AddTag"}}</span>
          </button>
        </div>
      </div>
    </form>

    {{if or .Tags .FilterQuery}}
    <!-- Server-side filtering using reusable component -->
    {{template "table_filter" (dict "Action" "/admin/tags" "FilterQuery" .FilterQuery "SortOrder" .SortOrder "Placeholder" (T "Admin.Tags.FilterPlaceholder") "TotalItems" .TotalTags "FilteredItems" .FilteredTags "ItemName" "tags")}}

    {{if .Tags}}
    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>
              <div class="field has-addons mb-0">
                <div class="control">
                  <span class="icon-text">
                    <span class="icon is-small"><i class="fas fa-tag"></i></span>
                    <span>{{T "Admin.Tags.Header.Name"}}</span>
                  </span>
                </div>
                <div class="control">
                  {{if eq .SortOrder "asc"}}
                  <a href="/admin/tags?sort=desc{{if .FilterQuery}}&filter={{.FilterQuery}}{{end}}" 
                     class="button is-small is-ghost" title="Sort descending">
                    <span class="icon is-small"><i class="fas fa-sort-up"></i></span>
                  </a>
                  {{else}}
                  <a href="/admin/tags?sort=asc{{if .FilterQuery}}&filter={{.FilterQuery}}{{end}}" 
                     class="button is-small is-ghost" title="Sort ascending">
                    <span class="icon is-small"><i class="fas fa-sort-down"></i></span>
                  </a>
                  {{end}}
                </div>
              </div>
            </th>
            {{if .TagCounts}}
            <th>{{T "Admin.Tags.Header.Usage"}}</th>
            {{end}}
            <th class="has-text-right">{{T "Common.Actions"}}</th>
          </tr>
        </thead>
        <tbody>
          {{range .Tags}}
          <tr>
            <td>
              <span class="tag is-info is-light">{{.}}</span>
            </td>
            {{if $.TagCounts}}
            <td>
              {{$count := index $.TagCounts .}}
              {{if $count}}
                <span class="tag is-success is-light">{{$count}} VMs</span>
              {{else}}
                <span class="tag is-light">0 VMs</span>
              {{end}}
            </td>
            {{end}}
            <td class="has-text-right">
              {{if ne . "pvmss"}}
              <form method="POST" action="/tags/delete" class="is-inline" 
                    onsubmit="return confirm('Delete tag &quot;{{.}}&quot;?')">
                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                <input type="hidden" name="tag" value="{{.}}">
                <button type="submit" class="button is-small is-danger is-outlined" 
                        title='{{T "Admin.Tags.DeleteTag"}} "{{.}}"'>
                  <span class="icon is-small"><i class="fas fa-trash"></i></span>
                </button>
              </form>
              {{else}}
              <span class="tag is-light">{{T "Admin.Tags.DefaultTag"}}</span>
              {{end}}
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
    {{else}}
    <div class="notification is-warning is-light">
      <div class="level is-mobile">
        <div class="level-left">
          <div class="level-item">
            <span class="icon has-text-warning">
              <i class="fas fa-search"></i>
            </span>
          </div>
          <div class="level-item">
            <p>No tags found matching your filter "{{.FilterQuery}}"</p>
          </div>
        </div>
      </div>
    </div>
    {{end}}
    {{else}}
    <div class="notification is-info is-light">
      <div class="level is-mobile">
        <div class="level-left">
          <div class="level-item">
            <span class="icon has-text-info">
              <i class="fas fa-info-circle"></i>
            </span>
          </div>
          <div class="level-item">
            <p>{{T "Admin.Tags.NoTags"}}</p>
          </div>
        </div>
      </div>
    </div>
    {{end}}
  </div>
  </div>
{{end}}