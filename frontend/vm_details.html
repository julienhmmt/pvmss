{{define "vm_details"}}
<section class="section">
    <div class="container">
        <div class="card admin-card">
            <header class="card-header brand-header is-align-items-center">
                <p class="card-header-title">
                    <span class="icon"><i class="fas fa-server"></i></span>&nbsp;{{.VM.Name}} (ID: {{.VM.VMID}})
                </p>
            </header>
            <div class="card-content">
                {{if .Error}}
                <div class="notification is-danger is-light">
                    <div class="content has-text-centered">
                        <p class="is-size-5 has-text-weight-semibold mt-2">{{.Error}}</p>
                    </div>
                </div>
                {{end}}
                {{if .Warning}}
                <div class="notification is-warning is-light">
                    <div class="content has-text-centered">
                        <p class="is-size-5 has-text-weight-semibold mt-2">{{.Warning}}</p>
                    </div>
                </div>
                {{end}}
                <table class="table is-fullwidth is-narrow">
                    <tbody>
                        <tr>
                            <th><i class="fas fa-tag"></i> {{T "VMDetails.Label.Name"}}</th>
                            <td>{{.VM.Name}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-hashtag"></i> {{T "VMDetails.Label.ID"}}</th>
                            <td>{{.VM.VMID}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-power-off"></i> {{T "VMDetails.Label.Status"}}</th>
                            <td>
                                <span id="vm-status-badge" class="tag is-medium {{if eq .VM.Status "running"}}is-success{{else if eq .VM.Status "stopped"}}is-danger{{else}}is-light{{end}}">
                                    <span id="vm-status-text">{{.VM.Status}}</span>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-clock"></i> {{T "VMDetails.Label.Uptime"}}</th>
                            <td>{{.VM.Uptime}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-microchip"></i> {{T "VMDetails.Label.CPU"}}</th>
                            <td>{{.VM.CPUs}} cores</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-memory"></i> {{T "VMDetails.Label.RAM"}}</th>
                            <td>{{.FormattedMaxMem}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-hdd"></i> {{T "VMDetails.Label.Disk"}}</th>
                            <td>{{.FormattedMaxDisk}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-network-wired"></i> {{T "VMDetails.Label.Network"}}</th>
                            <td>{{.NetworkBridges}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-info-circle"></i> {{T "VMDetails.Label.Description"}}</th>
                            <td>
                                {{if .DescriptionHTML}}
                                {{safeHTML .DescriptionHTML}}
                                {{else}}
                                {{.Description}}
                                {{end}}
                                {{if .ProxmoxConnected}}
                                <div class="is-pulled-right">
                                    <a class="button is-small is-light" href="/vm/details/{{.VM.VMID}}?edit=description">
                                        <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                        <span>Modify</span>
                                    </a>
                                </div>
                                {{end}}
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-tags"></i> Tags</th>
                            <td>
                                {{.Tags}}
                                {{if .ProxmoxConnected}}
                                <div class="is-pulled-right">
                                    <a class="button is-small is-light" href="/vm/details/{{.VM.VMID}}?edit=tags">
                                        <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                        <span>Modify</span>
                                    </a>
                                </div>
                                {{end}}
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Edit Description (Markdown) -->
                {{if .ShowDescriptionEditor}}
                <div class="box mt-5">
                    <h2 class="title is-5"><span class="icon"><i class="fas fa-edit"></i></span>&nbsp;Edit Description</h2>
                    <form action="/vm/update/description" method="post">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                        <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                        <input type="hidden" name="node" value="{{.VM.Node}}" />
                        <div class="field">
                            <label for="description" class="label">Description (Markdown supported)</label>
                            <div class="control">
                                <textarea id="description" name="description" class="textarea" rows="6" placeholder="Enter Markdown description...">{{.Description}}</textarea>
                            </div>
                            <p class="help">Use Markdown for formatting. The rendered version shows in the table above.</p>
                        </div>
                        <div class="field is-grouped is-justify-content-space-between">
                            <div class="control">
                                <a class="button" href="/vm/details/{{.VM.VMID}}">
                                    <span class="icon"><i class="fas fa-times"></i></span>
                                    <span>Cancel</span>
                                </a>
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary" {{if not .ProxmoxConnected}}disabled title="Offline mode"{{end}}>
                                    <span class="icon"><i class="fas fa-save"></i></span>
                                    <span>Save Description</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {{end}}

                <!-- Manage Tags -->
                {{if .ShowTagsEditor}}
                <div class="box mt-5">
                    <h2 class="title is-5"><span class="icon"><i class="fas fa-tags"></i></span>&nbsp;Manage Tags</h2>
                    <form action="/vm/update/tags" method="post">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                        <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                        <input type="hidden" name="node" value="{{.VM.Node}}" />
                        {{if .CurrentTags}}
                        <p class="mb-3 is-size-7 has-text-grey">
                            <strong>Currently applied:</strong> {{join .CurrentTags ", "}}
                        </p>
                        {{end}}
                        <div class="field">
                            <label class="label">Select tags</label>
                            <div class="tags">
                                {{if .AllTags}}
                                    {{range $tag := .AllTags}}
                                        {{if eq $tag "pvmss"}}
                                            <label class="checkbox mr-3" title="Mandatory tag">
                                                <input type="checkbox" checked disabled />
                                                <span class="tag is-primary">pvmss</span>
                                                <!-- submit disabled value -->
                                                <input type="hidden" name="tags" value="pvmss" />
                                            </label>
                                        {{else}}
                                            <label class="checkbox mr-3">
                                                <input type="checkbox" name="tags" value="{{$tag}}" {{if contains $.CurrentTags $tag}}checked{{end}} {{if not $.ProxmoxConnected}}disabled{{end}} />
                                                <span class="tag is-light">{{$tag}}</span>
                                            </label>
                                        {{end}}
                                    {{end}}
                                {{else}}
                                    <span class="has-text-grey">No tags available</span>
                                {{end}}
                            </div>
                        </div>
                        <div class="field is-grouped is-justify-content-space-between">
                            <div class="control">
                                <a class="button" href="/vm/details/{{.VM.VMID}}">
                                    <span class="icon"><i class="fas fa-times"></i></span>
                                    <span>Cancel</span>
                                </a>
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary" {{if not .ProxmoxConnected}}disabled title="Offline mode"{{end}}>
                                    <span class="icon"><i class="fas fa-save"></i></span>
                                    <span>Save Tags</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {{end}}
            </div>
        </div>

    </div>

    <!-- Refresh Button -->
    <div class="is-flex is-justify-content-center mb-4 mt-4">
        <a class="button is-info is-light"
            href="/vm/details/{{.VM.VMID}}?refresh=1">
            <span>{{T "VMDetails.Action.Refresh"}}</span>
        </a>
    </div>

    <!-- Open Console Button -->
    <div class="is-flex is-justify-content-center mb-4">
        {{if .ProxmoxConnected}}
            <button id="open-console-btn" class="button is-primary is-light"
                    data-vmid="{{.VM.VMID}}"
                    data-vmname="{{.VM.Name}}"
                    data-node="{{.VM.Node}}">
                <span>Open Console</span>
            </button>
        {{else}}
            <button class="button is-primary is-light" disabled title="Offline mode">
                <span>Open Console</span>
            </button>
        {{end}}
    </div>

    <!-- VM Action Forms (server-side) -->
    <div class="buttons is-centered mt-4">
        <form action="/vm/action" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="start" />
            <button class="button is-success is-light" {{if or (not .ProxmoxConnected) (eq .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Start"}}</span>
            </button>
        </form>
        <form action="/vm/action" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="reboot" />
            <button class="button is-warning is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Reboot"}}</span>
            </button>
        </form>
        <form action="/vm/action" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="shutdown" />
            <button class="button is-danger is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Shutdown"}}</span>
            </button>
        </form>
        <form action="/vm/action" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="stop" />
            <button class="button is-danger is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Stop"}}</span>
            </button>
        </form>
        <form action="/vm/action" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="reset" />
            <button class="button is-danger is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Reset"}}</span>
            </button>
        </form>
    </div>


    <div class="is-flex is-justify-content-center mb-4 mt-4">
        <a class="button is-info is-light" href="/search">
            <span>{{T "Common.BackToSearch"}}</span>
        </a>
    </div>

    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const consoleButton = document.getElementById('open-console-btn');
    if (consoleButton) {
        consoleButton.addEventListener('click', function () {
            const vmid = this.dataset.vmid;
            const vmname = this.dataset.vmname;
            const node = this.dataset.node;

            // Add a loading indicator to the button
            this.classList.add('is-loading');

            fetch(`/api/console/qemu/${vmid}?node=${encodeURIComponent(node)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to get VNC ticket. Status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Open proxied Proxmox noVNC page under our origin (same-origin cookies)
                    const vncTicket = data.vncticket || data.ticket; // backend may return either key
                    if (!vncTicket) {
                        throw new Error('Missing VNC ticket in response');
                    }
                    let consoleUrl = `/console/qemu/${encodeURIComponent(vmid)}?node=${encodeURIComponent(node)}&port=${encodeURIComponent(data.port)}&vncticket=${encodeURIComponent(vncTicket)}&vmname=${encodeURIComponent(vmname)}`;
                    if (data.vncpassword) {
                        consoleUrl += `&vncpassword=${encodeURIComponent(data.vncpassword)}`;
                    }

                    // Open the console in a new tab
                    window.open(consoleUrl, '_blank', 'noopener,noreferrer');
                })
                .catch(error => {
                    console.error('Error opening console:', error);
                    // You could display a notification to the user here
                    alert('Could not open console: ' + error.message);
                })
                .finally(() => {
                    // Remove the loading indicator
                    this.classList.remove('is-loading');
                });
        });
    }
});
</script>

{{end}}