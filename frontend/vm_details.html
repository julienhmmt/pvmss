{{define "vm_details"}}
<script>
  (function(){
    var base = '{{T "Title"}}';
    if (document.title === base) {
      var name = '{{.VM.Name}}';
      var vmid = '{{.VM.VMID}}';
      var title = '';
      var idLabel = '{{T "Common.ID"}}';
      if (name && name !== '' && vmid && vmid !== '0') {
        title = name + ' (' + idLabel + ' ' + vmid + ')';
      } else if (vmid && vmid !== '0') {
        title = idLabel + ' ' + vmid;
      } else if (name && name !== '') {
        title = name;
      } else {
        title = '{{T "VMDetails.EditResourcesTitle"}}';
      }
      document.title = title + ' - ' + base;
    }
  })();
  
  // Network card toggle function - Enhanced for instant feedback
  function toggleNetworkCard(cardIndex, enabled, csrfToken, vmid, node) {
    const toggleContainer = document.querySelector(`#network-toggle-${cardIndex}`);
    const toggleLabel = document.querySelector(`#network-toggle-${cardIndex} .network-toggle-label`);
    const toggleInput = document.querySelector(`#network-toggle-${cardIndex} input[type="checkbox"]`);
    const toggleSlider = document.querySelector(`#network-toggle-${cardIndex} .network-toggle-slider`);
    
    // Show loading state immediately
    const originalLabel = toggleLabel.innerHTML;
    toggleContainer.classList.add('loading');
    toggleLabel.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{T "Common.Processing"}}...';
    toggleInput.disabled = true;
    
    const formData = new URLSearchParams();
    formData.append('csrf_token', csrfToken);
    formData.append('vmid', vmid);
    formData.append('node', node);
    formData.append('card_index', cardIndex);
    formData.append('enabled', enabled ? '1' : '0');
    
    fetch('/vm/toggle/network', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
        return;
      }
      
      toggleContainer.classList.remove('loading');
      
      if (response.ok) {
        // Add success animation
        toggleContainer.classList.add('success');
        setTimeout(() => toggleContainer.classList.remove('success'), 600);
        
        // Update UI immediately for instant feedback
        updateNetworkCardUI(cardIndex, enabled);
        
        // Show success notification
        const successMsg = enabled ? '{{T "Message.NetworkCardEnabled"}}' : '{{T "Message.NetworkCardDisabled"}}';
        showSuccess(successMsg);
        
        // Optional: Refresh data in background after a short delay
        setTimeout(() => {
          refreshNetworkData();
        }, 1000);
        
      } else {
        // Add error animation
        toggleContainer.classList.add('error');
        setTimeout(() => toggleContainer.classList.remove('error'), 500);
        
        // Revert UI on failure
        toggleInput.checked = !enabled;
        toggleLabel.innerHTML = originalLabel;
        toggleInput.disabled = false;
        
        console.error('Network toggle failed');
        showError('{{T "Message.ActionFailed"}}');
      }
    })
    .catch(error => {
      toggleContainer.classList.remove('loading');
      
      // Add error animation
      toggleContainer.classList.add('error');
      setTimeout(() => toggleContainer.classList.remove('error'), 500);
      
      // Revert UI on error
      toggleInput.checked = !enabled;
      toggleLabel.innerHTML = originalLabel;
      toggleInput.disabled = false;
      
      console.error('Error:', error);
      showError('{{T "Message.ActionFailed"}}');
    });
  }
  
  // Update network card UI instantly
  function updateNetworkCardUI(cardIndex, enabled) {
    const toggleLabel = document.querySelector(`#network-toggle-${cardIndex} .network-toggle-label`);
    const toggleInput = document.querySelector(`#network-toggle-${cardIndex} input[type="checkbox"]`);
    const toggleContainer = document.querySelector(`#network-toggle-${cardIndex}`);
    
    // Update checkbox state
    toggleInput.checked = enabled;
    
    // Update label with smooth transition
    toggleLabel.style.opacity = '0';
    setTimeout(() => {
      if (enabled) {
        toggleLabel.innerHTML = '<i class="fas fa-plug-circle-check has-text-success"></i> {{T "Common.Enabled"}}';
      } else {
        toggleLabel.innerHTML = '<i class="fas fa-plug-circle-xmark has-text-grey"></i> {{T "Common.Disabled"}}';
      }
      toggleLabel.style.opacity = '1';
    }, 100);
    
    // Re-enable controls
    toggleInput.disabled = false;
    
    // Update tooltip
    const action = enabled ? '{{T "Common.Disable"}}' : '{{T "Common.Enable"}}';
    toggleContainer.title = `${action} {{T "VM.Create.Network"}} #${parseInt(cardIndex) + 1}`;
  }
  
  // Refresh network data in background (optional)
  function refreshNetworkData() {
    // This could refresh network interface data without full page reload
    // For now, we'll skip it to keep the experience fast
    console.log('Network data refreshed');
  }

  // Auto-refresh VM metrics
  let autoRefreshInterval;
  let isAutoRefreshEnabled = true;
  const vmid = '{{.VM.VMID}}';
  const node = '{{.VM.Node}}';

  function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    autoRefreshInterval = setInterval(() => {
      if (!isAutoRefreshEnabled) return;
      
      fetch(`/api/vm/${vmid}/metrics`)
        .then(response => {
          if (!response.ok) throw new Error('Failed to fetch metrics');
          return response.json();
        })
        .then(data => {
          updateVMMetrics(data);
        })
        .catch(error => {
          console.log('Auto-refresh paused:', error.message);
          // Don't show error to user, just pause refresh
        });
    }, 30000); // Refresh every 30 seconds
  }

  function updateVMMetrics(data) {
    // Update CPU usage
    const cpuElement = document.querySelector('[data-metric="cpu"]');
    if (cpuElement && data.cpu !== undefined) {
      const cpuPercent = Math.round(data.cpu * 100);
      cpuElement.textContent = cpuPercent + '%';
      
      // Update progress bar
      const cpuBar = document.querySelector('[data-progress="cpu"]');
      if (cpuBar) {
        cpuBar.value = cpuPercent;
      }
    }

    // Update RAM usage
    const ramElement = document.querySelector('[data-metric="ram"]');
    if (ramElement && data.mem !== undefined && data.maxmem !== undefined) {
      const ramPercent = Math.round((data.mem / data.maxmem) * 100);
      ramElement.textContent = formatBytes(data.mem) + ' / ' + formatBytes(data.maxmem);
      
      // Update progress bar
      const ramBar = document.querySelector('[data-progress="ram"]');
      if (ramBar) {
        ramBar.value = data.mem;
        ramBar.max = data.maxmem;
      }
    }

    // Update status if changed
    const statusBadge = document.getElementById('vm-status-badge');
    if (statusBadge && data.status) {
      const currentStatus = statusBadge.textContent.trim();
      if (currentStatus !== data.status) {
        // Status changed, show notification and reload
        showNotification('VM status changed to ' + data.status, 'info');
        setTimeout(() => window.location.reload(), 2000);
      }
    }
  }

  function formatBytes(bytes) {
    const gb = bytes / (1024 * 1024 * 1024);
    if (gb >= 1) {
      return gb.toFixed(1) + ' GB';
    }
    const mb = bytes / (1024 * 1024);
    return mb.toFixed(0) + ' MB';
  }

  function formatUptime(seconds) {
    if (seconds < 60) return seconds + 's';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
    return Math.floor(seconds / 86400) + 'd';
  }

  function showNotification(message, type = 'info', autoDismiss = true) {
    // Enhanced notification system with auto-dismissal and stacking
    const notificationId = 'notification-' + Date.now();
    const notification = document.createElement('div');
    notification.id = notificationId;
    notification.className = `notification is-${type} is-light`;
    notification.style.cssText = `
      position: fixed; 
      top: 20px; 
      right: 20px; 
      z-index: 9999; 
      max-width: 350px;
      min-width: 250px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    // Add icon based on type
    let icon = 'fas fa-info-circle';
    if (type === 'success') icon = 'fas fa-check-circle';
    if (type === 'warning') icon = 'fas fa-exclamation-triangle';
    if (type === 'danger') icon = 'fas fa-times-circle';
    
    notification.innerHTML = `
      <button class="delete" onclick="dismissNotification('${notificationId}')"></button>
      <div class="media">
        <div class="media-left">
          <span class="icon has-text-${type}">
            <i class="${icon}"></i>
          </span>
        </div>
        <div class="media-content">
          <p>${message}</p>
        </div>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    // Position notification with stacking
    positionNotification(notification);
    
    // Animate in
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateX(0)';
    }, 50);
    
    // Auto-dismiss after specified time
    if (autoDismiss) {
      const dismissTime = type === 'success' ? 3000 : type === 'danger' ? 8000 : 5000;
      setTimeout(() => {
        dismissNotification(notificationId);
      }, dismissTime);
    }
    
    return notificationId;
  }

  function dismissNotification(notificationId) {
    const notification = document.getElementById(notificationId);
    if (!notification) return;
    
    // Animate out
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    
    // Remove after animation
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
        // Reposition remaining notifications
        repositionAllNotifications();
      }
    }, 300);
  }

  function positionNotification(notification) {
    const existingNotifications = document.querySelectorAll('.notification[id^="notification-"]:not([id="' + notification.id + '"])');
    const topOffset = 20 + (existingNotifications.length * 80);
    notification.style.top = topOffset + 'px';
  }

  function repositionAllNotifications() {
    const notifications = document.querySelectorAll('.notification[id^="notification-"]');
    notifications.forEach((notif, index) => {
      const topOffset = 20 + (index * 80);
      notif.style.top = topOffset + 'px';
    });
  }

  // Global notification shortcuts
  window.showSuccess = (message) => showNotification(message, 'success');
  window.showError = (message) => showNotification(message, 'danger');
  window.showWarning = (message) => showNotification(message, 'warning');
  window.showInfo = (message) => showNotification(message, 'info');

  // Pause auto-refresh when user is interacting
  function pauseAutoRefresh() {
    isAutoRefreshEnabled = false;
    setTimeout(() => {
      isAutoRefreshEnabled = true;
    }, 60000); // Resume after 1 minute of inactivity
  }

  // Loading indicators for VM actions
  function showLoadingOnButton(button, loadingText) {
    if (!button) return;
    
    // Store original content
    const originalContent = button.innerHTML;
    button.setAttribute('data-original-content', originalContent);
    
    // Show loading state
    button.innerHTML = `
      <span class="icon">
        <i class="fas fa-spinner fa-spin"></i>
      </span>
      <span>${loadingText}</span>
    `;
    button.disabled = true;
    button.classList.add('is-loading');
  }

  function restoreButton(button) {
    if (!button) return;
    
    const originalContent = button.getAttribute('data-original-content');
    if (originalContent) {
      button.innerHTML = originalContent;
      button.removeAttribute('data-original-content');
    }
    button.disabled = false;
    button.classList.remove('is-loading');
  }

  // Enhanced form submission with loading indicators
  function enhanceVMActionForms() {
    const actionForms = document.querySelectorAll('form[action="/vm/action"]');
    
    actionForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const submitButton = form.querySelector('button[type="submit"]');
        const action = form.querySelector('input[name="action"]').value;
        
        let loadingText = 'Processing...';
        switch(action) {
          case 'start': loadingText = 'Starting...'; break;
          case 'stop': loadingText = 'Stopping...'; break;
          case 'reboot': loadingText = 'Rebooting...'; break;
          case 'shutdown': loadingText = 'Shutting down...'; break;
          case 'reset': loadingText = 'Resetting...'; break;
        }
        
        showLoadingOnButton(submitButton, loadingText);
        
        // Disable all other action buttons during operation
        const allActionButtons = document.querySelectorAll('form[action="/vm/action"] button');
        allActionButtons.forEach(btn => {
          if (btn !== submitButton) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
          }
        });
      });
    });
  }

  // Initialize auto-refresh
  document.addEventListener('DOMContentLoaded', function() {
    // Only start auto-refresh for running VMs
    const statusBadge = document.getElementById('vm-status-badge');
    if (statusBadge && statusBadge.textContent.includes('Running')) {
      startAutoRefresh();
    }

    // Pause refresh on user interaction
    document.addEventListener('click', pauseAutoRefresh);
    document.addEventListener('keypress', pauseAutoRefresh);
    
    // Show refresh indicator
    const refreshBtn = document.querySelector('a[href*="refresh=1"]');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = this.href;
      });
    }

    // Enhance VM action forms with loading indicators
    enhanceVMActionForms();
  });
</script>
<section class="section">
    <div class="container max-w-1200">
        {{/* Standard notifications */}}
        {{if .Success}}
        {{template "notification" (dict 
          "Type" "success" 
          "Message" .SuccessMessage 
          "Icon" "fas fa-check" 
          "Dismissible" true
        )}}
        {{end}}
        {{if .Error}}
        {{template "notification" (dict 
          "Type" "danger" 
          "Message" .ErrorMessage 
          "Icon" "fas fa-exclamation-triangle" 
          "Dismissible" true
        )}}
        {{end}}
        {{if .Warning}}
        {{template "notification" (dict 
          "Type" "warning" 
          "Message" .WarningMessage 
          "Icon" "fas fa-exclamation-triangle" 
          "Dismissible" true
        )}}
        {{end}}

        <!-- Navigation Links -->
        <div class="level mb-4">
            <div class="level-left"></div>
            <div class="level-right">
                <div class="level-item">
                    <div class="buttons">
                        <a href="/profile" class="button is-primary">
                            <span class="icon is-small"><i class="fas fa-user"></i></span>
                            <span>{{T "Navbar.Profile"}}</span>
                        </a>
                        <a href="/search" class="button is-primary">
                            <span class="icon is-small"><i class="fas fa-search"></i></span>
                            <span>{{T "Common.Search"}}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- VM Overview - Header + Stats + Actions -->
        <div class="card mb-4">
            <!-- VM Header -->
            <div class="card-content vm-header">
                <div class="level is-mobile mb-0">
                    <div class="level-left">
                        <div class="level-item">
                            <div>
                                <h1 class="title is-4 mb-2" style="font-weight: 700;">
                                    <span class="icon-text">
                                        <span class="icon has-text-primary"><i class="fas fa-server"></i></span>
                                        <span>{{.VM.Name}}</span>
                                    </span>
                                </h1>
                                <div class="is-flex is-flex-wrap-wrap" style="gap: 0.5rem;">
                                    <div class="tags has-addons mb-0">
                                        <span class="tag is-light">ID</span>
                                        <span class="tag is-dark">{{.VM.VMID}}</span>
                                    </div>
                                    <div class="tags has-addons mb-0">
                                        <span class="tag is-light">Node</span>
                                        <span class="tag is-primary is-light">{{.VM.Node}}</span>
                                    </div>
                                    <div class="tags has-addons mb-0">
                                        <span class="tag is-light"><i class="fas fa-clock"></i></span>
                                        <span class="tag is-warning" data-metric="uptime">{{if eq .VM.Status "running"}}{{.FormattedUptime}}{{else}}Stopped{{end}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <span id="vm-status-badge">{{template "status_badge" (dict "Status" .VM.Status "WithIcon" true)}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VM Stats Grid -->
            <div class="card-content pt-4 pb-3 px-3">
                <div class="columns is-mobile is-multiline is-variable is-2">
                    <!-- CPU Stat -->
                    <div class="column is-one-third-tablet is-half-mobile">
                        <div class="is-hoverable" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); height: 100%; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='0 1px 4px rgba(0,0,0,0.04)'">
                            <!-- Header -->
                            <div class="is-flex is-align-items-center is-justify-content-space-between mb-4">
                                <div class="is-flex is-align-items-center">
                                    <span class="icon has-text-primary mr-3" style="font-size: 1.25rem;">
                                        <i class="fas fa-microchip"></i>
                                    </span>
                                    <div>
                                        <div class="has-text-grey-dark is-size-6" style="font-weight: 600;">{{T "VMDetails.Label.CPU"}}</div>
                                        <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{T "VMDetails.CPU.UsageLabel"}}</div>
                                    </div>
                                </div>
                                <div class="has-text-right">
                                    <div class="has-text-primary is-size-5" style="font-weight: 600;" data-metric="cpu">
                                        {{if eq .VM.Status "running"}}{{printf "%.0f" (mul .VM.CPU 100)}}%{{else}}--{{end}}
                                    </div>
                                    <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{.VM.CPUs}} vCPU{{if gt .VM.CPUs 1}}s{{end}}</div>
                                </div>
                            </div>
                            
                            <!-- CPU Details -->
                            <div style="margin-top: 1.5rem;">
                                <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500;">
                                    <i class="fas fa-microchip" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px;"></i>
                                    {{.VM.CPUs}} core{{if gt .VM.CPUs 1}}s{{end}}
                                    {{if eq .VM.Status "running"}}
                                    <span class="tag" style="background: rgb(255 136 0 / 12%); color: var(--primary-dark); border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; margin-left: 0.5rem;">
                                        {{T "VMDetails.CPU.Active"}}
                                    </span>
                                    {{end}}
                                </div>
                                {{if eq .VM.Status "running"}}
                                <div style="margin-top: 0.75rem;">
                                    <progress class="progress is-small is-primary" value="{{mul .VM.CPU 100}}" max="100" data-progress="cpu" style="height: 6px; border-radius: 3px;"></progress>
                                </div>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    <!-- RAM Stat -->
                    <div class="column is-one-third-tablet is-half-mobile">
                        <div class="is-hoverable" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); height: 100%; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='0 1px 4px rgba(0,0,0,0.04)'">
                            <!-- Header -->
                            <div class="is-flex is-align-items-center is-justify-content-space-between mb-4">
                                <div class="is-flex is-align-items-center">
                                    <span class="icon has-text-success mr-3" style="font-size: 1.25rem;">
                                        <i class="fas fa-memory"></i>
                                    </span>
                                    <div>
                                        <div class="has-text-grey-dark is-size-6" style="font-weight: 600;">{{T "VMDetails.Label.RAM"}}</div>
                                        <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{T "VMDetails.RAM.UsageLabel"}}</div>
                                    </div>
                                </div>
                                <div class="has-text-right">
                                    <div class="has-text-success is-size-5" style="font-weight: 600;" data-metric="ram">
                                        {{if eq .VM.Status "running"}}{{.FormattedMemGB}}{{else}}--{{end}}
                                    </div>
                                    <div class="has-text-grey is-size-7" style="margin-top: 2px;">
                                        {{if eq .VM.Status "running"}}{{printf "%.0f" (mul (div (float64 .VM.Mem) (float64 .VM.MaxMem)) 100)}}%{{else}}{{T "VMDetails.RAM.Total"}}{{end}}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- RAM Details -->
                            <div style="margin-top: 1.5rem;">
                                <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500;">
                                    <i class="fas fa-memory" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px;"></i>
                                    {{if eq .VM.Status "running"}}{{.FormattedMemGB}} / {{.FormattedMaxMemGB}} {{T "VMDetails.RAM.Used"}}{{else}}{{.FormattedMaxMemGB}} {{T "VMDetails.RAM.Total"}}{{end}}
                                    {{if eq .VM.Status "running"}}
                                    <span class="tag" style="background: rgba(34,197,94,0.08); color: #16a34a; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; margin-left: 0.5rem;">
                                        {{T "VMDetails.RAM.InUse"}}
                                    </span>
                                    {{end}}
                                </div>
                                {{if eq .VM.Status "running"}}
                                <div style="margin-top: 0.75rem;">
                                    <progress class="progress is-small is-success" value="{{.VM.Mem}}" max="{{.VM.MaxMem}}" data-progress="ram" style="height: 6px; border-radius: 3px;"></progress>
                                </div>
                                {{end}}
                            </div>
                        </div>
                    </div>

                    <!-- Disk Stat -->
                    <div class="column is-one-third-tablet is-half-mobile">
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); height: 100%;">
                            <!-- Header -->
                            <div class="is-flex is-align-items-center is-justify-content-space-between mb-4">
                                <div class="is-flex is-align-items-center">
                                    <span class="icon has-text-primary mr-3" style="font-size: 1.25rem;">
                                        <i class="fas fa-hdd"></i>
                                    </span>
                                    <div>
                                        <div class="has-text-grey-dark is-size-6" style="font-weight: 600;">{{T "VMDetails.Section.Disks"}}</div>
                                        <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{T "VMDetails.Section.DisksDescription"}}</div>
                                    </div>
                                </div>
                                {{$diskCount := len .Disks}}
                                {{if gt $diskCount 0}}
                                <div class="has-text-right">
                                    <div class="has-text-primary is-size-5" style="font-weight: 600;">{{$diskCount}}</div>
                                    <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{T "VMDetails.Disks.Total"}}: {{.DisksTotalLabel}}</div>
                                </div>
                                {{end}}
                            </div>
                            
                            {{if gt $diskCount 0}}
                            <!-- Disks List -->
                            <div style="margin-top: 1.5rem;">
                                {{range $i, $d := .Disks}}
                                <div class="is-hoverable" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: {{if eq (len $.Disks) (int (add $i 1))}}0{{else}}0.75rem{{end}}; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                                    <div class="is-flex is-align-items-start is-justify-content-between">
                                        <div class="is-flex" style="gap: 0.75rem; flex: 1; min-width: 0;">
                                            <span class="has-text-primary" style="font-size: 1.1rem; font-weight: 600; line-height: 1;">
                                                <i class="fas fa-hdd"></i>
                                                {{$d.Index}}
                                            </span>
                                            <div class="is-flex" style="gap: 0.5rem; flex-wrap: wrap;">
                                                {{if $d.Bus}}
                                                <span class="tag" style="background: rgb(255 136 0 / 12%); color: var(--primary-dark); border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; display: inline-flex; align-items: center; gap: 4px;">
                                                    <span style="width: 6px; height: 6px; border-radius: 50%; background: {{$d.Color}}; display: inline-block;"></span>
                                                    {{$d.Bus}}
                                                </span>
                                                {{end}}
                                                {{if $d.Storage}}
                                                <span class="tag" style="background: rgb(255 136 0 / 12%); color: var(--primary-dark); border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4;">
                                                    {{$d.Storage}}
                                                </span>
                                                {{else}}
                                                <span class="tag" style="background: rgba(245,158,11,0.08); color: #92400e; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4;">
                                                    {{$d.Raw}}
                                                </span>
                                                {{end}}
                                            </div>
                                        </div>
                                    </div>
                                    {{if gt $d.SizeGB 0}}
                                    <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500; margin-top: 0.75rem;">
                                        <i class="fas fa-database" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px;"></i>
                                        {{$d.SizeLabel}}
                                    </div>
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                            {{else}}
                            <!-- Empty State -->
                            <div style="text-align: center; padding: 2rem 0;">
                                <span class="icon has-text-grey-light" style="font-size: 2.5rem;">
                                    <i class="fas fa-hdd"></i>
                                </span>
                                <p class="has-text-grey is-size-6" style="margin-top: 1rem;">{{T "VMDetails.Disks.EmptyTitle"}}</p>
                                <p class="has-text-grey-light is-size-7" style="margin-top: 0.5rem;">{{T "VMDetails.Disks.EmptySubtitle"}}</p>
                            </div>
                            {{end}}
                        </div>
                    </div>

                    <!-- Network Summary Card -->
                    {{if .NetworkInterfaces}}
                    {{$ifaceCount := len .NetworkInterfaces}}
                    <div class="column {{if eq $ifaceCount 1}}is-one-third-tablet is-half-mobile{{else}}is-full-tablet{{end}}">
                        <div class="is-hoverable" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); height: 100%; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='0 1px 4px rgba(0,0,0,0.04)'">
                            <!-- Header -->
                            <div class="is-flex is-align-items-center is-justify-content-space-between mb-4">
                                <div class="is-flex is-align-items-center">
                                    <span class="icon has-text-primary mr-3" style="font-size: 1.25rem;">
                                        <i class="fas fa-network-wired"></i>
                                    </span>
                                    <div>
                                        <div class="has-text-grey-dark is-size-6" style="font-weight: 600;">{{T "VMDetails.Section.Network"}}</div>
                                        <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{T "VMDetails.Section.NetworkDescription"}}</div>
                                    </div>
                                </div>
                                <div class="has-text-right">
                                    <div class="has-text-primary is-size-5" style="font-weight: 600;">{{$ifaceCount}}</div>
                                    <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{if eq $ifaceCount 1}}{{T "VMDetails.Network.InterfaceSingular"}}{{else}}{{T "VMDetails.Network.InterfacePlural"}}{{end}}</div>
                                </div>
                            </div>
                            <!-- Network Interfaces List -->
                            <div style="margin-top: 1.5rem;">
                                {{range $i, $iface := .NetworkInterfaces}}
                                <div class="is-hoverable" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: {{if eq $ifaceCount (int (add $i 1))}}0{{else}}0.75rem{{end}}; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                                    <div class="is-flex is-align-items-start is-justify-content-between">
                                        <div class="is-flex" style="gap: 0.75rem; flex: 1; min-width: 0;">
                                            <span class="has-text-primary" style="font-size: 1.1rem; font-weight: 600; line-height: 1;">
                                                <i class="fas fa-network-wired" style="color: var(--primary);"></i>
                                                {{$iface.Index}}
                                            </span>
                                            <div class="is-flex" style="gap: 0.5rem; flex-wrap: wrap;">
                                                {{if $iface.Bridge}}
                                                <span class="tag" style="background: rgb(255 136 0 / 12%); color: var(--primary-dark); border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4;">
                                                    {{$iface.Bridge}}
                                                </span>
                                                {{end}}
                                                {{if $iface.ModelLabel}}
                                                <span class="tag" style="background: rgb(255 136 0 / 12%); color: var(--primary-dark); border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4;">
                                                    {{$iface.ModelLabel}}
                                                </span>
                                                {{end}}
                                                {{if $iface.LinkDown}}
                                                <span class="tag" style="background: rgba(245,158,11,0.08); color: #d97706; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4;">
                                                    <i class="fas fa-link-slash" style="font-size: 0.7rem;"></i> {{T "Status.Down"}}
                                                </span>
                                                {{end}}
                                            </div>
                                        </div>
                                    </div>
                                    {{if $iface.IPAddresses}}
                                    <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500; margin-top: 0.75rem;">
                                        <i class="fas fa-ethernet has-text-primary" style="font-size: 0.85rem; margin-right: 6px;"></i>
                                        {{range $j, $ip := $iface.IPAddresses}}
                                            {{if gt $j 0}}, {{end}}{{$ip}}
                                        {{end}}
                                    </div>
                                    {{end}}
                                </div>
                                {{end}}
                            </div>
                                                    </div>
                    </div>
                    {{end}}

                    <!-- Firmware & Security (EFI / TPM) -->
                    <div class="column is-full-tablet is-full-mobile">
                        <div class="is-hoverable" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.04); height: 100%; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='0 1px 4px rgba(0,0,0,0.04)'">
                            <!-- Header -->
                            <div class="is-flex is-align-items-center is-justify-content-space-between mb-4">
                                <div class="is-flex is-align-items-center">
                                    <span class="icon has-text-grey mr-3" style="font-size: 1.25rem;">
                                        <i class="fas fa-shield-alt"></i>
                                    </span>
                                    <div>
                                        <div class="has-text-grey-dark is-size-6" style="font-weight: 600;">{{T "VMDetails.Section.Security"}}</div>
                                        <div class="has-text-grey is-size-7" style="margin-top: 2px;">{{T "VMDetails.Section.SecurityDescription"}}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Security Features -->
                            <div style="margin-top: 1.5rem;">
                                <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                                    {{if .EFIEnabled}}
                                    <div class="is-hoverable" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; flex: 1; min-width: 200px; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                                        <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500;">
                                            <i class="fas fa-microchip" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px; color: #16a34a;"></i>
                                            {{T "VMDetails.Security.EFIBoot"}}
                                            <span class="tag" style="background: rgba(34,197,94,0.08); color: #16a34a; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; margin-left: 0.5rem;">
                                                {{T "Common.Enabled"}}
                                            </span>
                                        </div>
                                        {{if .EFIStorage}}
                                        <div class="has-text-grey" style="font-size: 0.85rem; margin-top: 0.5rem;">
                                            {{T "Common.Storage"}}: {{.EFIStorage}}
                                        </div>
                                        {{end}}
                                    </div>
                                    {{else}}
                                    <div class="is-hoverable" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; flex: 1; min-width: 200px; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                                        <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500;">
                                            <i class="fas fa-microchip" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px;"></i>
                                            {{T "VMDetails.Security.EFIBoot"}}
                                            <span class="tag" style="background: rgba(156,163,175,0.08); color: #6b7280; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; margin-left: 0.5rem;">
                                                {{T "Common.Disabled"}}
                                            </span>
                                        </div>
                                    </div>
                                    {{end}}

                                    {{if .TPMEnabled}}
                                    <div class="is-hoverable" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; flex: 1; min-width: 200px; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                                        <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500;">
                                            <i class="fas fa-shield-alt" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px; color: #16a34a;"></i>
                                            {{T "VMDetails.Security.TPM"}}
                                            <span class="tag" style="background: rgba(34,197,94,0.08); color: #16a34a; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; margin-left: 0.5rem;">
                                                {{T "Common.Enabled"}}
                                            </span>
                                        </div>
                                    </div>
                                    {{else}}
                                    <div class="is-hoverable" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; flex: 1; min-width: 200px; transition: all 0.15s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)'" onmouseout="this.style.boxShadow='none'">
                                        <div class="has-text-grey-dark" style="font-size: 0.9rem; font-weight: 500;">
                                            <i class="fas fa-shield-alt" style="font-size: 0.85rem; opacity: 0.6; margin-right: 6px;"></i>
                                            {{T "VMDetails.Security.TPM"}}
                                            <span class="tag" style="background: rgba(156,163,175,0.08); color: #6b7280; border: none; font-size: 0.75rem; padding: 0.25rem 0.5rem; line-height: 1.4; margin-left: 0.5rem;">
                                                {{T "Common.Disabled"}}
                                            </span>
                                        </div>
                                    </div>
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card-content pt-0 pb-4 px-4" style="border-top: 1px solid rgb(0,0,0,6%);">
                <div class="has-text-centered mb-2 mt-3">
                    <span class="has-text-grey is-size-7" style="text-transform: uppercase; font-weight: 600; letter-spacing: 0.05em;">Actions rapides</span>
                </div>
                {{template "action_buttons" (dict 
                    "VMID" .VM.VMID 
                    "Node" .VM.Node 
                    "Status" .VM.Status 
                    "CSRFToken" .CSRFToken 
                    "ProxmoxConnected" .ProxmoxConnected 
                    "Lang" .Lang
                    "ExtraClasses" "is-flex-wrap-wrap is-justify-content-center"
                )}}
                {{if .ProxmoxConnected}}
                <div class="has-text-centered mt-4 pt-3" style="border-top: 1px solid rgb(0,0,0,6%);">
                    <a href="{{printf "/vm/details/%d?edit=resources" .VM.VMID}}" class="button is-primary">
                        <span class="icon is-small"><i class="fas fa-sliders"></i></span>
                        <span>{{T "VMDetails.ModifyResources"}}</span>
                    </a>
                </div>
                {{end}}
            </div>
        </div>

        

        <!-- Description & Tags Grid -->
        <div class="columns is-variable is-5">
            <!-- Description -->
            <div class="column {{if .Tags}}is-7{{else}}is-12{{end}}">
                <div class="card mb-5">
                    <header class="card-header brand-header is-align-items-center">
                        <p class="card-header-title">
                            <span class="icon-text">
                                <span class="icon"><i class="fas fa-info-circle"></i></span>
                                <span>{{T "VMDetails.Label.Description"}}</span>
                            </span>
                        </p>
                        {{if .ProxmoxConnected}}
                        <a href="{{printf "/vm/details/%d?edit=description" .VM.VMID}}" class="button is-light mr-3">
                            <span class="icon is-small"><i class="fas fa-edit"></i></span>
                            <span class="is-hidden-mobile">{{T "VMDetails.Modify"}}</span>
                        </a>
                        {{end}}
                    </header>
                    <div class="card-content content">
                        {{if .Description}}
                            {{if .DescriptionHTML}}
                            {{safeHTML .DescriptionHTML}}
                            {{else}}
                            <p>{{.Description}}</p>
                            {{end}}
                        {{else}}
                            <p class="has-text-grey-light is-italic mb-0">{{T "VMDetails.NoDescription"}}</p>
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Tags -->
            {{if .Tags}}
            <div class="column is-5">
                <div class="card mb-5">
                    <header class="card-header brand-header is-align-items-center">
                        <p class="card-header-title">
                            <span class="icon-text">
                                <span class="icon"><i class="fas fa-tags"></i></span>
                                <span>{{T "Common.Tags"}}</span>
                            </span>
                        </p>
                        {{if .ProxmoxConnected}}
                        <a href="{{printf "/vm/details/%d?edit=tags" .VM.VMID}}" class="button is-light mr-3">
                            <span class="icon is-small"><i class="fas fa-edit"></i></span>
                            <span class="is-hidden-mobile">{{T "VMDetails.Modify"}}</span>
                        </a>
                        {{end}}
                    </header>
                    <div class="card-content">
                        <div class="tags are-medium">
                            {{range $tag := split .Tags ", "}}
                            <span class="tag tag-pvmss">{{$tag}}</span>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
            {{end}}
        </div>

        <!-- Empty state -->
        {{if and (not .Description) (not .Tags) .ProxmoxConnected}}
        <div class="card mb-5">
            <div class="card-content has-text-centered py-6">
                <span class="icon has-text-grey-lighter mb-3" style="font-size: 3rem;">
                    <i class="fas fa-info-circle"></i>
                </span>
                <p class="title is-5 has-text-grey mb-3">No description or tags yet</p>
                <p class="has-text-grey-light is-size-6 mb-4">Add information about this VM to help organize and document your infrastructure</p>
                <div class="buttons is-centered">
                    <a href="{{printf "/vm/details/%d?edit=description" .VM.VMID}}" class="button is-primary is-light">
                        <span class="icon"><i class="fas fa-edit"></i></span>
                        <span>Add Description</span>
                    </a>
                    <a href="{{printf "/vm/details/%d?edit=tags" .VM.VMID}}" class="button is-link is-light">
                        <span class="icon"><i class="fas fa-tags"></i></span>
                        <span>Add Tags</span>
                    </a>
                </div>
            </div>
        </div>
        {{end}}

        <!-- Edit Description (Markdown) -->
        {{if .ShowDescriptionEditor}}
        <div class="card mb-5">
            <header class="card-header brand-header">
                <p class="card-header-title">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-edit"></i></span>
                        <span>{{T "VMDetails.EditDescriptionTitle"}}</span>
                    </span>
                </p>
            </header>
            <div class="card-content">
                <form action="/vm/update/description" method="post">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                    <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                    <input type="hidden" name="node" value="{{.VM.Node}}" />
                    <div class="field">
                        <label for="description" class="label has-text-weight-semibold">{{T "VMDetails.DescriptionLabel"}}</label>
                        <div class="control">
                            <textarea id="description" name="description" class="textarea" rows="6" placeholder="{{T "VMDetails.DescriptionPlaceholder"}}">{{.Description}}</textarea>
                        </div>
                        <p class="help has-text-grey">{{T "VMDetails.DescriptionHelp"}}</p>
                    </div>
                    <hr class="my-4">
                    <div class="field is-grouped is-justify-content-space-between">
                        <div class="control">
                            <a class="button is-light" href="{{printf "/vm/details/%d" .VM.VMID}}">
                                <span class="icon"><i class="fas fa-times"></i></span>
                                <span>{{T "Common.Cancel"}}</span>
                            </a>
                        </div>
                        <div class="control">
                            <button type="submit" class="button is-primary is-medium" {{if not .ProxmoxConnected}}disabled title="Offline mode"{{end}}>
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>{{T "VMDetails.SaveDescription"}}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {{end}}

        <!-- Manage Tags -->
        {{if .ShowTagsEditor}}
        <div class="card mb-5">
            <header class="card-header brand-header">
                <p class="card-header-title">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-tags"></i></span>
                        <span>{{T "Common.Tags"}}</span>
                    </span>
                </p>
            </header>
            <div class="card-content">
                <form action="/vm/update/tags" method="post">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                    <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                    <input type="hidden" name="node" value="{{.VM.Node}}" />
                    {{if .CurrentTags}}
                    <div class="notification is-light is-primary mb-4">
                        <p class="is-size-7">
                            <strong>{{T "VMDetails.TagsCurrentlyAppliedPrefix"}}</strong> {{join .CurrentTags ", "}}
                        </p>
                    </div>
                    {{end}}
                    <div class="field">
                        <label class="label has-text-weight-semibold">{{T "VMDetails.SelectTags"}}</label>
                        <div class="tags">
                            {{if .AllTags}}
                                {{range $tag := .AllTags}}
                                    {{if eq $tag "pvmss"}}
                                        <label class="checkbox mr-3" title="Mandatory tag">
                                            <input type="checkbox" checked disabled />
                                            <span class="tag is-primary">pvmss</span>
                                            <!-- submit disabled value -->
                                            <input type="hidden" name="tags" value="pvmss" />
                                        </label>
                                    {{else}}
                                        <label class="checkbox mr-3">
                                            <input type="checkbox" name="tags" value="{{$tag}}" {{if contains $.CurrentTags $tag}}checked{{end}} {{if not $.ProxmoxConnected}}disabled{{end}} />
                                            <span class="tag is-light">{{$tag}}</span>
                                        </label>
                                    {{end}}
                                {{end}}
                            {{else}}
                                <span class="has-text-grey">{{T "VMDetails.NoTagsAvailable"}}</span>
                            {{end}}
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="field is-grouped is-justify-content-space-between">
                        <div class="control">
                            <a class="button is-light" href="{{printf "/vm/details/%d" .VM.VMID}}">
                                <span class="icon"><i class="fas fa-times"></i></span>
                                <span>{{T "Common.Cancel"}}</span>
                            </a>
                        </div>
                        <div class="control">
                            <button type="submit" class="button is-primary is-medium" {{if not .ProxmoxConnected}}disabled title="Offline mode"{{end}}>
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>{{T "VMDetails.SaveTags"}}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {{end}}

        <!-- Edit Resources (CPU, Memory, Network) -->
        {{if .ShowResourcesEditor}}
        <div class="card mb-5">
            <header class="card-header brand-header">
                <p class="card-header-title">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-sliders"></i></span>
                        <span>{{T "VMDetails.EditResourcesTitle"}}</span>
                    </span>
                </p>
            </header>
            <div class="card-content">
                {{/* Check if VM is running */}}
                {{$isRunning := eq .VM.Status "running"}}
                
                {{/* Show error notification if VM is running */}}
                {{if $isRunning}}
                {{template "notification" (dict "Type" "danger" "Title" (T "VMDetails.ResourcesDisabledTitle") "Message" (T "VMDetails.ResourcesDisabledMessage") "Icon" "fas fa-exclamation-circle" "Dismissible" false)}}
                {{end}}

                <form action="/vm/update/resources" method="post" {{if $isRunning}}disabled{{end}}>
                    {{$ctx := .}}
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                    <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                    <input type="hidden" name="node" value="{{.VM.Node}}" />

                    {{/* Extract VM limits from settings */}}
                    {{$vm := index .Limits "vm"}}
                    {{$vmSockMin := int (index (index $vm "sockets") "min")}}
                    {{$vmSockMax := int (index (index $vm "sockets") "max")}}
                    {{$vmCoreMin := int (index (index $vm "cores") "min")}}
                    {{$vmCoreMax := int (index (index $vm "cores") "max")}}
                    {{$vmRamMinGB := int (index (index $vm "ram") "min")}}
                    {{$vmRamMaxGB := int (index (index $vm "ram") "max")}}
                    {{$vmRamMinMB := int (mul $vmRamMinGB 1024)}}
                    {{$vmRamMaxMB := int (mul $vmRamMaxGB 1024)}}

                    <div class="notification is-light is-primary mb-4">
                        <p class="is-size-7">
                            <strong>{{T "VMDetails.ResourcesWarning"}}</strong> {{T "VMDetails.ResourcesWarningText"}}
                        </p>
                    </div>

                    <!-- CPU Configuration -->
                    <div class="field" {{if $isRunning}}style="opacity: 0.6; pointer-events: none;"{{end}}>
                        <label class="label has-text-weight-semibold">
                            <span class="icon-text">
                                <span class="icon"><i class="fas fa-microchip"></i></span>
                                <span>{{T "VM.Create.CPUCores"}}</span>
                            </span>
                        </label>
                        <div class="columns is-mobile is-variable is-2">
                            <div class="column">
                                <label class="label is-size-7 has-text-grey">{{T "VM.Create.CPUSockets"}}</label>
                                <div class="control">
                                    <div class="select is-fullwidth is-medium">
                                        <select name="sockets" required {{if $isRunning}}disabled{{end}}>
                                            {{range $i := seq $vmSockMin (int (add $vmSockMax 1))}}
                                            <option value="{{$i}}" {{if eq $i $ctx.CurrentSockets}}selected{{end}}>{{$i}}</option>
                                            {{end}}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <label class="label is-size-7 has-text-grey">{{T "VM.Create.CPUCores"}}</label>
                                <div class="control">
                                    <div class="select is-fullwidth is-medium">
                                        <select name="cores" required {{if $isRunning}}disabled{{end}}>
                                            {{range $i := seq $vmCoreMin (int (add $vmCoreMax 1))}}
                                            <option value="{{$i}}" {{if eq $i $ctx.CurrentCores}}selected{{end}}>{{$i}}</option>
                                            {{end}}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Memory Configuration -->
                    <div class="field" {{if $isRunning}}style="opacity: 0.6; pointer-events: none;"{{end}}>
                        <label for="memory" class="label has-text-weight-semibold">
                            <span class="icon-text">
                                <span class="icon"><i class="fas fa-memory"></i></span>
                                <span>{{T "Common.Memory"}}</span>
                            </span>
                        </label>
                        <div class="field has-addons">
                            <div class="control is-expanded">
                                <input id="memory" class="input is-medium" type="number" name="memory" min="{{$vmRamMinMB}}" max="{{$vmRamMaxMB}}" step="128" value="{{.CurrentMemory}}" required inputmode="numeric" {{if $isRunning}}disabled{{end}}>
                            </div>
                            <div class="control"><span class="button is-static is-medium">MB</span></div>
                        </div>
                    </div>

                    <!-- Network Configuration -->
                    {{if .NetworkCards}}
                    <hr class="my-4">
                    <div class="field">
                        <label class="label has-text-weight-semibold">
                            <span class="icon-text">
                                <span class="icon"><i class="fas fa-network-wired"></i></span>
                                <span>{{T "VM.Create.Network"}}</span>
                            </span>
                        </label>
                        {{range $idx, $card := .NetworkCards}}
                        <div class="box is-shadowless p-3 mb-3" style="background: rgba(0,0,0,0.02); position: relative;">
                            <div class="is-flex is-justify-content-space-between is-align-items-center mb-2">
                                <strong>{{T "VM.Create.Network"}} #{{addInt $idx 1}}</strong>
                                <div class="is-flex is-align-items-center">
                                    {{if and (gt $.MaxNetworkCards 1) (gt (addInt $idx 1) 1)}}
                                    <span class="tag is-light is-size-7 mr-2">{{T "VM.Create.NetworkOptional"}}</span>
                                    {{end}}
                                    {{if $card.Exists}}
                                    <label id="network-toggle-{{$idx}}" class="network-toggle-switch" 
                                      title="{{if $card.LinkDown}}{{T "Common.Enable"}}{{else}}{{T "Common.Disable"}}{{end}} {{T "VM.Create.Network"}} #{{addInt $idx 1}}">
                                      <input type="checkbox" 
                                        {{if not $card.LinkDown}}checked{{end}}
                                        onchange="toggleNetworkCard({{$idx}}, this.checked, '{{$.CSRFToken}}', '{{$.VM.VMID}}', '{{$.VM.Node}}')">
                                      <span class="network-toggle-slider"></span>
                                      <span class="network-toggle-label">
                                        {{if $card.LinkDown}}
                                          <i class="fas fa-plug-circle-xmark has-text-grey"></i> {{T "Common.Disabled"}}
                                        {{else}}
                                          <i class="fas fa-plug-circle-check has-text-success"></i> {{T "Common.Enabled"}}
                                        {{end}}
                                      </span>
                                    </label>
                                    {{end}}
                                </div>
                            </div>
                                    <div class="columns is-mobile is-variable is-2">
                                        <div class="column">
                                            <label class="label is-size-7 has-text-grey" for="networkBridge_{{$idx}}">{{T "VM.Create.NetworkBridge"}}</label>
                                            <div class="control">
                                                <div class="select is-fullwidth is-medium">
                                                    <select id="networkBridge_{{$idx}}" name="bridge_{{$idx}}" {{if eq $idx 0}}required{{end}} {{if $isRunning}}disabled{{end}}>
                                                        {{if and (gt (addInt $idx 1) 1) (not $card.Exists)}}<option value="" selected>-- {{T "VM.Create.NoNetwork"}} --</option>{{end}}
                                                        {{if and (gt (addInt $idx 1) 1) $card.Exists}}<option value="">-- {{T "VM.Create.NoNetwork"}} --</option>{{end}}
                                                        {{range $bridge := $.AvailableVMBRs}}
                                                        <option value="{{$bridge}}" {{if eq $bridge $card.Bridge}}selected{{end}}>{{$bridge}}</option>
                                                        {{end}}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="column">
                                            <label class="label is-size-7 has-text-grey" for="networkModel_{{$idx}}">{{T "VM.Create.NetworkModel"}}</label>
                                            <div class="control">
                                                <div class="select is-fullwidth is-medium">
                                                    <select id="networkModel_{{$idx}}" name="network_model_{{$idx}}" {{if eq $idx 0}}required{{end}} {{if $isRunning}}disabled{{end}}>
                                                        <option value="virtio" title="{{T "VM.Create.NetworkModel.Virtio"}}" {{if eq $card.Model "virtio"}}selected{{end}}>VirtIO</option>
                                                        <option value="e1000" title="{{T "VM.Create.NetworkModel.E1000"}}" {{if eq $card.Model "e1000"}}selected{{end}}>E1000</option>
                                                        <option value="e1000e" title="{{T "VM.Create.NetworkModel.E1000E"}}" {{if eq $card.Model "e1000e"}}selected{{end}}>E1000E</option>
                                                        <option value="rtl8139" title="{{T "VM.Create.NetworkModel.RTL8139"}}" {{if eq $card.Model "rtl8139"}}selected{{end}}>RTL8139</option>
                                                        <option value="vmxnet3" title="{{T "VM.Create.NetworkModel.VMXNet3"}}" {{if eq $card.Model "vmxnet3"}}selected{{end}}>VMXNet3</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            <input type="hidden" name="mac_{{$idx}}" value="{{$card.MAC}}">
                            <input type="hidden" name="exists_{{$idx}}" value="{{if $card.Exists}}1{{else}}0{{end}}">
                            <input type="hidden" name="options_{{$idx}}" value="{{if $card.Options}}{{join $card.Options ","}}{{end}}">
                            <input type="hidden" name="link_down_{{$idx}}" value="{{if $card.LinkDown}}1{{else}}0{{end}}">
                            {{if $card.MAC}}
                            <p class="help is-size-7 mt-1">MAC: {{$card.MAC}}</p>
                            {{end}}
                            {{if $card.Options}}
                            <p class="help is-size-7 has-text-grey mt-1">{{T "VMDetails.NetworkOptions"}}: {{join $card.Options ", "}}</p>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                    {{end}}

                    <hr class="my-4">
                    <div class="field is-grouped is-justify-content-space-between">
                        <div class="control">
                            <a class="button is-light" href="{{printf "/vm/details/%d" .VM.VMID}}">
                                <span class="icon"><i class="fas fa-times"></i></span>
                                <span>{{T "Common.Cancel"}}</span>
                            </a>
                        </div>
                        <div class="control">
                            <button type="submit" class="button is-primary is-medium" {{if or (not .ProxmoxConnected) $isRunning}}disabled{{end}} {{if $isRunning}}title="Stop the VM to modify resources"{{end}}>
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>{{T "VMDetails.SaveResources"}}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {{end}}
    </div>
    <!-- Console Modal -->
    <div id="console-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card console-modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">
                    <span class="icon"><i class="fas fa-desktop"></i></span>
                    Console - {{.VM.Name}} ({{.VM.VMID}})
                </p>
                <button id="console-close" class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body flex-column" style="padding: 0;">
                <!-- Status bar -->
                <div id="console-status" class="console-status-bar">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-circle-notch fa-spin"></i></span>
                        <span id="console-status-text">Connecting...</span>
                    </span>
                </div>
                <!-- noVNC container -->
                <div id="console-container" class="console-container"></div>
            </section>
            <footer class="modal-card-foot console-footer">
                <div class="console-controls">
                    <button id="console-ctrl-alt-del" class="button is-small is-light" disabled>
                        <span class="icon"><i class="fas fa-keyboard"></i></span>
                        <span class="is-hidden-mobile">Ctrl+Alt+Del</span>
                    </button>
                    <button id="console-scale-toggle" class="button is-small is-primary" disabled title="Toggle viewport scaling to fit screen">
                        <span class="icon"><i class="fas fa-expand-arrows-alt"></i></span>
                        <span class="is-hidden-mobile">Scale: On</span>
                    </button>
                    <button id="console-fullscreen" class="button is-small is-light" disabled>
                        <span class="icon"><i class="fas fa-expand"></i></span>
                        <span class="is-hidden-mobile">Fullscreen</span>
                    </button>
                </div>
                <button id="console-disconnect" class="button is-danger is-light">
                    <span class="icon"><i class="fas fa-times"></i></span>
                    <span>Disconnect</span>
                </button>
            </footer>
        </div>
    </div>
</section>

<!-- Console JavaScript -->
<script type="module">
    import { initConsoleManager } from '/js/vm-console.js';
    
    // Initialize console manager
    initConsoleManager({
        vmid: '{{.VM.VMID}}',
        node: '{{.VM.Node}}',
        csrfToken: '{{.CSRFToken}}',
        vmName: '{{.VM.Name}}'
    });
</script>

{{end}}