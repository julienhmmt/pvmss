{{define "vm_details.html"}}
<section class="section">
    <div class="container">
        <h1 class="title">{{.VMName}} (ID: {{.VMID}})</h1>
        <div class="box">
            <table class="table is-fullwidth">
                <tbody>
                    <tr>
                        <th>{{.DetailLabelName}}</th>
                        <td>{{.VMName}}</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelID}}</th>
                        <td>{{.VMID}}</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelStatus}}</th>
                        <td>{{.Status}}</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelUptime}}</th>
                        <td>{{.Uptime}}</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelCPU}}</th>
                        <td>{{.Sockets}} sockets / {{.Cores}} cores</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelRAM}}</th>
                        <td>{{.RAM}}</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelDisk}}</th>
                        <td>{{.DiskCount}} ({{.DiskTotalSize}})</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelNetwork}}</th>
                        <td>{{.NetworkBridges}}</td>
                    </tr>
                    <tr>
                        <th>{{.DetailLabelDescription}}</th>
                        <td>{{.Description}}</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
    <!-- Refresh Button -->
    <div class="has-text-centered mb-4">
        <button class="button is-info is-light" id="refresh-btn">
            <span>{{.VMDetailsActionRefresh}}</span>
        </button>
    </div>
    <!-- VM Action Buttons -->
    <div class="buttons is-centered mt-4" id="vm-action-buttons">
            <button class="button is-success is-light" data-action="start" {{if eq .Status "running"}}disabled{{end}}>
                <span>{{.VMDetailsActionStart}}</span>
            </button>
            <button class="button is-warning is-light" data-action="reboot" disabled>
                <span>{{.VMDetailsActionReboot}}</span>
            </button>
            <button class="button is-danger is-light" data-action="shutdown" {{if ne .Status "running"}}disabled{{end}}>
                <span>{{.VMDetailsActionShutdown}}</span>
            </button>
            <button class="button is-danger is-light" data-action="stop" {{if ne .Status "running"}}disabled{{end}}>
                <span>{{.VMDetailsActionStop}}</span>
            </button>
            <button class="button is-danger is-light" data-action="reset" {{if ne .Status "running"}}disabled{{end}}>
                <span>{{.VMDetailsActionReset}}</span>
            </button>
        </div>
        <div id="vm-action-feedback" class="has-text-centered mt-2"></div>
        <script>
        // Localized feedback messages
        const msgProcessing = '{{.VMDetailsActionProcessing}}';
        const msgSuccess = '{{.VMDetailsActionSuccess}}';
        const msgFailed = '{{.VMDetailsActionFailed}}';
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('#vm-action-buttons button[data-action]');
            const feedback = document.getElementById('vm-action-feedback');
            const vmid = '{{.VMID}}';
            const node = '{{.Node}}';
            function setFeedback(msg, type) {
                feedback.textContent = msg;
                feedback.className = 'has-text-centered mt-2';
                if (type === 'success') feedback.classList.add('has-text-success');
                if (type === 'error') feedback.classList.add('has-text-danger');
                if (type === 'loading') feedback.classList.add('has-text-info');
            }
            // Refresh button handler
            document.getElementById('refresh-btn').addEventListener('click', function() {
                window.location.reload();
            });
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = btn.getAttribute('data-action');
                    setFeedback(msgProcessing, 'loading');
                    buttons.forEach(b => b.disabled = true);
                    fetch('/vm/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `action=${encodeURIComponent(action)}&vmid=${encodeURIComponent(vmid)}&node=${encodeURIComponent(node)}`
                    })
                    .then(res => {
                        if (res.ok) return res.text();
                        return res.text().then(t => { throw new Error(t); });
                    })
                    .then(() => {
                        setFeedback(msgSuccess, 'success');
                        setTimeout(() => feedback.textContent = '', 3000);
                        // Optionally: reload status here
                    })
                    .catch(err => {
                        setFeedback(msgFailed.replace('{{.Error}}', err.message), 'error');
                    })
                    .finally(() => {
                        buttons.forEach(b => b.disabled = false);
                    });
                });
            });
        });
        </script>

        <a href="/search" class="button is-light">{{.BackToSearch}}</a>
    </div>
</section>
{{end}}
