{{define "vm_details.html"}}
<section class="section">
    <div class="container">
        <h1 class="title">{{.VMName}} (ID: {{.VMID}})</h1>
        <div class="box">
            <table class="table is-fullwidth">
                <tbody>
                    <tr>
                        <th>{{index . "VMDetails.Label.Name"}}</th>
                        <td>{{.VMName}}</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.ID"}}</th>
                        <td>{{.VMID}}</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.Status"}}</th>
                        <td>
                            <span id="vm-status-badge" class="tag is-medium {{if eq .Status "running"}}is-success{{else if eq .Status "stopped"}}is-danger{{else}}is-light{{end}}">
                                <span id="vm-status-text">{{.Status}}</span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.Uptime"}}</th>
                        <td>{{.Uptime}}</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.CPU"}}</th>
                        <td>{{.Sockets}} sockets / {{.Cores}} cores</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.RAM"}}</th>
                        <td>{{.RAM}}</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.Disk"}}</th>
                        <td>{{.DiskCount}} ({{.DiskTotalSize}})</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.Network"}}</th>
                        <td>{{.NetworkBridges}}</td>
                    </tr>
                    <tr>
                        <th>{{index . "VMDetails.Label.Description"}}</th>
                        <td>{{.Description}}</td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <!-- Refresh Button -->
    <div class="is-flex is-justify-content-center mb-4" style="margin-top: 1.5rem;">
        <button class="button is-info is-light" id="refresh-btn" style="min-width: 170px; box-shadow: 0 2px 8px #e3e9f6; border-radius: 8px; display: flex; align-items: center; gap: 0.5em;">
            <span>{{index . "VMDetails.Action.Refresh"}}</span>
            <span id="refresh-spinner" class="icon is-small" style="display: none;"></span>
        </button>
    </div>

    <!-- VM Action Buttons -->
    <div class="buttons is-centered mt-4" id="vm-action-buttons">
        <button class="button is-success is-light" data-action="start">
            <span>{{index . "VMDetails.Action.Start"}}</span>
        </button>
        <button class="button is-warning is-light" data-action="reboot">
            <span>{{index . "VMDetails.Action.Reboot"}}</span>
        </button>
        <button class="button is-danger is-light" data-action="shutdown">
            <span>{{index . "VMDetails.Action.Shutdown"}}</span>
        </button>
        <button class="button is-danger is-light" data-action="stop">
            <span>{{index . "VMDetails.Action.Stop"}}</span>
        </button>
        <button class="button is-danger is-light" data-action="reset">
            <span>{{index . "VMDetails.Action.Reset"}}</span>
        </button>
    </div>

    <div id="vm-action-feedback" class="has-text-centered mt-2"></div>
        <script>
        // Localized feedback messages
        const msgProcessing = '{{index . "VMDetails.Action.Processing"}}';
        const msgSuccess = '{{index . "VMDetails.Action.Success"}}';
        const msgFailed = '{{index . "VMDetails.Action.Failed"}}';
        document.addEventListener('DOMContentLoaded', function() {
            const buttons = document.querySelectorAll('#vm-action-buttons button[data-action]');
            const feedback = document.getElementById('vm-action-feedback');
            const statusBadge = document.getElementById('vm-status-badge');
            const statusText = document.getElementById('vm-status-text');
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshSpinner = document.getElementById('refresh-spinner');
            
            // Get VM info from template
            const vmid = '{{.VMID}}';
            const node = '{{.Node}}';

            function setFeedback(msg, type) {
                feedback.textContent = msg;
                feedback.className = 'has-text-centered mt-2';
                if (type === 'success') feedback.classList.add('has-text-success');
                if (type === 'error') feedback.classList.add('has-text-danger');
                if (type === 'loading') feedback.classList.add('has-text-info');
            }

            function setStatusBadge(status) {
                statusText.textContent = status;
                statusBadge.className = 'tag is-medium';
                if (status === 'running') statusBadge.classList.add('is-success');
                else if (status === 'stopped') statusBadge.classList.add('is-danger');
                else statusBadge.classList.add('is-light');
            }

            function setActionButtons(status) {
                buttons.forEach(btn => {
                    const action = btn.getAttribute('data-action');
                    if (action === 'start') btn.disabled = (status === 'running');
                    else if (["stop","shutdown","reset","reboot"].includes(action)) btn.disabled = (status !== 'running');
                });
            }

            function fetchStatus(updateUI = true) {
                fetch(`/api/vm/status?vmid=${encodeURIComponent(vmid)}&node=${encodeURIComponent(node)}`)
                    .then(res => res.json())
                    .then(data => {
                        const status = (data.data && data.data.status) || data.status || 'unknown';
                        if (updateUI) {
                            setStatusBadge(status);
                            setActionButtons(status);
                        }
                    });
            }

            // Initial status fetch (in case page is stale)
            fetchStatus();

            // Refresh button handler
            refreshBtn.addEventListener('click', function() {
                refreshSpinner.style.display = '';
                setFeedback(msgProcessing, 'loading');
                fetchStatus();
                setTimeout(() => {
                    refreshSpinner.style.display = 'none';
                    setFeedback('', '');
                }, 1000);
            });

            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = btn.getAttribute('data-action');
                    setFeedback(msgProcessing, 'loading');
                    buttons.forEach(b => b.disabled = true);
                    fetch('/vm/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `csrf_token={{.CSRFToken}}&action=${encodeURIComponent(action)}&vmid=${encodeURIComponent(vmid)}&node=${encodeURIComponent(node)}`
                    })
                    .then(res => {
                        if (res.ok) return res.text();
                        return res.text().then(t => { throw new Error(t); });
                    })
                    .then(() => {
                        setFeedback(msgSuccess, 'success');
                        setTimeout(() => feedback.textContent = '', 3000);
                        // Refresh status after action
                        setTimeout(fetchStatus, 1000);
                    })
                    .catch(err => {
                        setFeedback(msgFailed.replace('{{.Error}}', err.message), 'error');
                    })
                    .finally(() => {
                        setTimeout(() => setActionButtons(statusText.textContent), 1200);
                    });
                });
            });
        });
        </script>

        <a href="/search" class="button is-light">{{index . "Common.BackToSearch"}}</a>

    </div>
</section>
{{end}}
