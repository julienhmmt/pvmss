{{define "vm_details"}}
<section class="section">
    <div class="container">
        <div class="card admin-card">
            <header class="card-header brand-header is-align-items-center">
                <p class="card-header-title">
                    <span class="icon"><i class="fas fa-server"></i></span>&nbsp;{{.VM.Name}} (ID: {{.VM.VMID}})
                </p>
            </header>
            <div class="card-content">
                {{/* Standard notifications */}}
                {{if .Success}}
                {{template "notification" (dict 
                  "Type" "success" 
                  "Message" .SuccessMessage 
                  "Icon" "fas fa-check" 
                  "Dismissible" true
                )}}
                {{end}}
                {{if .Error}}
                {{template "notification" (dict 
                  "Type" "danger" 
                  "Message" .ErrorMessage 
                  "Icon" "fas fa-exclamation-triangle" 
                  "Dismissible" true
                )}}
                {{end}}
                {{if .Warning}}
                {{template "notification" (dict 
                  "Type" "warning" 
                  "Message" .WarningMessage 
                  "Icon" "fas fa-exclamation-triangle" 
                  "Dismissible" true
                )}}
                {{end}}
                <table class="table is-fullwidth is-narrow">
                    <tbody>
                        <tr>
                            <th><i class="fas fa-tag"></i> {{T "VMDetails.Label.Name"}}</th>
                            <td>{{.VM.Name}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-hashtag"></i> {{T "VMDetails.Label.ID"}}</th>
                            <td>{{.VM.VMID}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-power-off"></i> {{T "VMDetails.Label.Status"}}</th>
                            <td>
                                <span id="vm-status-badge" class="tag is-medium {{if eq .VM.Status "running"}}is-success{{else if eq .VM.Status "stopped"}}is-danger{{else}}is-light{{end}}">
                                    <span id="vm-status-text">{{.VM.Status}}</span>
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-clock"></i> {{T "VMDetails.Label.Uptime"}}</th>
                            <td>{{.VM.Uptime}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-microchip"></i> {{T "VMDetails.Label.CPU"}}</th>
                            <td>{{.VM.CPUs}} cores</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-memory"></i> {{T "VMDetails.Label.RAM"}}</th>
                            <td>{{.FormattedMaxMem}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-hdd"></i> {{T "VMDetails.Label.Disk"}}</th>
                            <td>{{.FormattedMaxDisk}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-network-wired"></i> {{T "VMDetails.Label.Network"}}</th>
                            <td>{{.NetworkBridges}}</td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-info-circle"></i> {{T "VMDetails.Label.Description"}}</th>
                            <td>
                                {{if .DescriptionHTML}}
                                {{safeHTML .DescriptionHTML}}
                                {{else}}
                                {{.Description}}
                                {{end}}
                                {{if .ProxmoxConnected}}
                                <div class="is-pulled-right">
                                    <a class="button is-small is-light" href="{{withLang (printf "/vm/details/%d?edit=description" .VM.VMID) .Lang}}">
                                        <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                        <span>{{T "VMDetails.Modify"}}</span>
                                    </a>
                                </div>
                                {{end}}
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-tags"></i> {{T "Common.Tags"}}</th>
                            <td>
                                {{.Tags}}
                                {{if .ProxmoxConnected}}
                                <div class="is-pulled-right">
                                    <a class="button is-small is-light" href="{{withLang (printf "/vm/details/%d?edit=tags" .VM.VMID) .Lang}}">
                                        <span class="icon is-small"><i class="fas fa-edit"></i></span>
                                        <span>{{T "VMDetails.Modify"}}</span>
                                    </a>
                                </div>
                                {{end}}
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Edit Description (Markdown) -->
                {{if .ShowDescriptionEditor}}
                <div class="box mt-5">
                    <h2 class="title is-5"><span class="icon"><i class="fas fa-edit"></i></span>&nbsp;{{T "VMDetails.EditDescriptionTitle"}}</h2>
                    <form action="{{withLang "/vm/update/description" .Lang}}" method="post">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                        <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                        <input type="hidden" name="node" value="{{.VM.Node}}" />
                        <div class="field">
                            <label for="description" class="label">{{T "VMDetails.DescriptionLabel"}}</label>
                            <div class="control">
                                <textarea id="description" name="description" class="textarea" rows="6" placeholder="{{T "VMDetails.DescriptionPlaceholder"}}">{{.Description}}</textarea>
                            </div>
                            <p class="help">{{T "VMDetails.DescriptionHelp"}}</p>
                        </div>
                        <div class="field is-grouped is-justify-content-space-between">
                            <div class="control">
                                <a class="button" href="{{withLang (printf "/vm/details/%d" .VM.VMID) .Lang}}">
                                    <span class="icon"><i class="fas fa-times"></i></span>
                                    <span>{{T "Common.Cancel"}}</span>
                                </a>
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary" {{if not .ProxmoxConnected}}disabled title="Offline mode"{{end}}>
                                    <span class="icon"><i class="fas fa-save"></i></span>
                                    <span>{{T "VMDetails.SaveDescription"}}</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {{end}}

                <!-- Manage Tags -->
                {{if .ShowTagsEditor}}
                <div class="box mt-5">
                    <h2 class="title is-5"><span class="icon"><i class="fas fa-tags"></i></span>&nbsp;{{T "Common.Tags"}}</h2>
                    <form action="{{withLang "/vm/update/tags" .Lang}}" method="post">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
                        <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
                        <input type="hidden" name="node" value="{{.VM.Node}}" />
                        {{if .CurrentTags}}
                        <p class="mb-3 is-size-7 has-text-grey">
                            <strong>{{T "VMDetails.TagsCurrentlyAppliedPrefix"}}</strong> {{join .CurrentTags ", "}}
                        </p>
                        {{end}}
                        <div class="field">
                            <label class="label">{{T "VMDetails.SelectTags"}}</label>
                            <div class="tags">
                                {{if .AllTags}}
                                    {{range $tag := .AllTags}}
                                        {{if eq $tag "pvmss"}}
                                            <label class="checkbox mr-3" title="Mandatory tag">
                                                <input type="checkbox" checked disabled />
                                                <span class="tag is-primary">pvmss</span>
                                                <!-- submit disabled value -->
                                                <input type="hidden" name="tags" value="pvmss" />
                                            </label>
                                        {{else}}
                                            <label class="checkbox mr-3">
                                                <input type="checkbox" name="tags" value="{{$tag}}" {{if contains $.CurrentTags $tag}}checked{{end}} {{if not $.ProxmoxConnected}}disabled{{end}} />
                                                <span class="tag is-light">{{$tag}}</span>
                                            </label>
                                        {{end}}
                                    {{end}}
                                {{else}}
                                    <span class="has-text-grey">{{T "VMDetails.NoTagsAvailable"}}</span>
                                {{end}}
                            </div>
                        </div>
                        <div class="field is-grouped is-justify-content-space-between">
                            <div class="control">
                                <a class="button" href="{{withLang (printf "/vm/details/%d" .VM.VMID) .Lang}}">
                                    <span class="icon"><i class="fas fa-times"></i></span>
                                    <span>{{T "Common.Cancel"}}</span>
                                </a>
                            </div>
                            <div class="control">
                                <button type="submit" class="button is-primary" {{if not .ProxmoxConnected}}disabled title="Offline mode"{{end}}>
                                    <span class="icon"><i class="fas fa-save"></i></span>
                                    <span>{{T "VMDetails.SaveTags"}}</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {{end}}
            </div>
        </div>

    </div>

    <!-- Refresh Button -->
    <div class="is-flex is-justify-content-center mb-4 mt-4">
        <a class="button is-info is-light"
            href="{{withLang (printf "/vm/details/%d?refresh=1" .VM.VMID) .Lang}}">
            <span>{{T "VMDetails.Action.Refresh"}}</span>
        </a>
    </div>

    <!-- VM Action Forms (server-side) -->
    <div class="buttons is-centered mt-4">
        <form action="{{withLang "/vm/action" .Lang}}" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="start" />
            <button class="button is-success is-light" {{if or (not .ProxmoxConnected) (eq .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Start"}}</span>
            </button>
        </form>
        <form action="{{withLang "/vm/action" .Lang}}" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="reboot" />
            <button class="button is-warning is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Reboot"}}</span>
            </button>
        </form>
        <form action="{{withLang "/vm/action" .Lang}}" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="shutdown" />
            <button class="button is-danger is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Shutdown"}}</span>
            </button>
        </form>
        <form action="{{withLang "/vm/action" .Lang}}" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="stop" />
            <button class="button is-danger is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Stop"}}</span>
            </button>
        </form>
        <form action="{{withLang "/vm/action" .Lang}}" method="post" class="is-inline-block mx-1">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
            <input type="hidden" name="vmid" value="{{.VM.VMID}}" />
            <input type="hidden" name="node" value="{{.VM.Node}}" />
            <input type="hidden" name="action" value="reset" />
            <button class="button is-danger is-light" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
                <span>{{T "VMDetails.Action.Reset"}}</span>
            </button>
        </form>
    </div>

    <!-- Console Button -->
    <div class="buttons is-centered mt-4">
        <button id="console-button" class="button is-primary" {{if or (not .ProxmoxConnected) (ne .VM.Status "running")}}disabled{{end}}>
            <span class="icon"><i class="fas fa-desktop"></i></span>
            <span>{{T "VMDetails.Action.Console"}}</span>
        </button>
    </div>

    <!-- Console Modal -->
    <div id="console-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card" style="width: 95%; max-width: 1400px; height: 90%;">
            <header class="modal-card-head">
                <p class="modal-card-title">
                    <span class="icon"><i class="fas fa-desktop"></i></span>
                    Console - {{.VM.Name}} ({{.VM.VMID}})
                </p>
                <button id="console-close" class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body" style="padding: 0; display: flex; flex-direction: column;">
                <!-- Status bar -->
                <div id="console-status" style="padding: 0.5rem; background: #f5f5f5; border-bottom: 1px solid #dbdbdb;">
                    <span class="icon-text">
                        <span class="icon"><i class="fas fa-circle-notch fa-spin"></i></span>
                        <span id="console-status-text">Connecting...</span>
                    </span>
                </div>
                <!-- noVNC container -->
                <div id="console-container" style="flex: 1; position: relative; overflow: auto; background: #000;"></div>
            </section>
            <footer class="modal-card-foot" style="justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="console-ctrl-alt-del" class="button is-small is-light" disabled>
                        <span class="icon"><i class="fas fa-keyboard"></i></span>
                        <span class="is-hidden-mobile">Ctrl+Alt+Del</span>
                    </button>
                    <button id="console-scale-toggle" class="button is-small is-info" disabled title="Toggle viewport scaling to fit screen">
                        <span class="icon"><i class="fas fa-expand-arrows-alt"></i></span>
                        <span class="is-hidden-mobile">Scale: On</span>
                    </button>
                    <button id="console-fullscreen" class="button is-small is-light" disabled>
                        <span class="icon"><i class="fas fa-expand"></i></span>
                        <span class="is-hidden-mobile">Fullscreen</span>
                    </button>
                </div>
                <button id="console-disconnect" class="button is-danger is-light">
                    <span class="icon"><i class="fas fa-times"></i></span>
                    <span>Disconnect</span>
                </button>
            </footer>
        </div>
    </div>

    <div class="is-flex is-justify-content-center mb-4 mt-4">
        <a class="button is-info is-light" href="{{withLang "/search" .Lang}}">
            <span>{{T "Common.BackToSearch"}}</span>
        </a>
    </div>

    </div>
</section>

<!-- Console JavaScript with noVNC Module -->
<script type="module">
    // Import noVNC RFB module
    import RFB from '/components/noVNC-1.6.0/core/rfb.js';
    
    // Configuration
    const VMID = '{{.VM.VMID}}';
    const NODE = '{{.VM.Node}}';
    const CSRF_TOKEN = '{{.CSRFToken}}';
    
    // DOM elements
    const consoleButton = document.getElementById('console-button');
    const consoleModal = document.getElementById('console-modal');
    const consoleClose = document.getElementById('console-close');
    const consoleDisconnect = document.getElementById('console-disconnect');
    const consoleStatus = document.getElementById('console-status-text');
    const consoleContainer = document.getElementById('console-container');
    const ctrlAltDelButton = document.getElementById('console-ctrl-alt-del');
    const scaleToggleButton = document.getElementById('console-scale-toggle');
    const fullscreenButton = document.getElementById('console-fullscreen');
    
    // noVNC connection
    let rfb = null;
    let scaleViewport = true; // Default to scaling enabled for better mobile/small screen experience
    
    // Update status message
    function updateStatus(message, type = 'info') {
        const statusDiv = document.getElementById('console-status');
        const icon = statusDiv.querySelector('.icon i');
        
        consoleStatus.textContent = message;
        
        // Update icon based on type
        icon.className = 'fas fa-' + (
            type === 'success' ? 'check-circle' :
            type === 'error' ? 'exclamation-circle' :
            type === 'connecting' ? 'circle-notch fa-spin' :
            'info-circle'
        );
        
        // Update background color
        statusDiv.style.background = (
            type === 'success' ? '#d4edda' :
            type === 'error' ? '#f8d7da' :
            '#f5f5f5'
        );
    }
    
    // Open console
    async function openConsole() {
        try {
            updateStatus('Requesting console access...', 'connecting');
            
            // Step 1: Get VNC ticket from backend
            const response = await fetch(`/api/vm/vnc-ticket?vmid=${VMID}&node=${NODE}`, {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': CSRF_TOKEN,
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: response.statusText }));
                throw new Error(error.error || 'Failed to get console ticket');
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to get console ticket');
            }
            
            const { ticket, port } = data;
            
            // Step 2: Build WebSocket URL
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/vm/console/websocket?vmid=${VMID}&node=${NODE}&port=${port}&vncticket=${encodeURIComponent(ticket)}`;
            
            updateStatus('Connecting to console...', 'connecting');
            
            // Step 3: Check if noVNC is available
            if (typeof RFB === 'undefined') {
                throw new Error('noVNC library not loaded. Please ensure noVNC components are properly installed.');
            }
            
            // Step 4: Create noVNC connection
            // For Proxmox VNC: The vncticket is passed in the URL AND used as the password
            // during VNC authentication. This is how Proxmox's VNC implementation works.
            rfb = new RFB(consoleContainer, wsUrl, {
                credentials: { 
                    username: '',  // Proxmox doesn't use username for VNC
                    password: ticket  // The VNC ticket is used as the password
                }
            });
            
            // Enable viewport scaling for responsive display
            rfb.scaleViewport = scaleViewport;
            rfb.resizeSession = false; // Don't resize the remote session
            rfb.clipViewport = false;  // Don't clip viewport when scaling
            
            // Set up event handlers
            rfb.addEventListener('connect', handleConnect);
            rfb.addEventListener('disconnect', handleDisconnect);
            rfb.addEventListener('securityfailure', handleSecurityFailure);
            
            // Enable console controls
            ctrlAltDelButton.disabled = false;
            scaleToggleButton.disabled = false;
            fullscreenButton.disabled = false;
            
            // Update scale toggle button appearance
            updateScaleButton();
            
            console.log('Console connection initiated');
            
        } catch (error) {
            console.error('Console error:', error);
            updateStatus(error.message, 'error');
            
            // Show error notification
            setTimeout(() => {
                if (confirm('Failed to open console: ' + error.message + '\n\nWould you like to try again?')) {
                    closeConsole();
                    setTimeout(openConsole, 500);
                } else {
                    closeConsole();
                }
            }, 500);
        }
    }
    
    // noVNC event handlers
    function handleConnect() {
        console.log('Console connected');
        updateStatus('Connected', 'success');
        
        // Focus the noVNC canvas
        const canvas = consoleContainer.querySelector('canvas');
        if (canvas) {
            canvas.focus();
        }
    }
    
    function handleDisconnect(e) {
        console.log('Console disconnected:', e.detail);
        
        if (e.detail.clean) {
            updateStatus('Disconnected', 'info');
        } else {
            updateStatus('Connection lost: ' + (e.detail.reason || 'Unknown error'), 'error');
        }
        
        // Disable controls
        ctrlAltDelButton.disabled = true;
        scaleToggleButton.disabled = true;
        fullscreenButton.disabled = true;
        
        // Auto-close modal after a delay if disconnected
        if (!e.detail.clean) {
            setTimeout(() => {
                if (consoleModal.classList.contains('is-active')) {
                    closeConsole();
                }
            }, 3000);
        }
    }
    
    function handleSecurityFailure(e) {
        console.error('Security failure:', e.detail);
        updateStatus('Authentication failed: ' + (e.detail.reason || 'Security error'), 'error');
        
        setTimeout(() => {
            closeConsole();
        }, 3000);
    }
    
    // Close console
    function closeConsole() {
        // Disconnect noVNC
        if (rfb) {
            try {
                rfb.disconnect();
            } catch (e) {
                console.error('Error disconnecting:', e);
            }
            rfb = null;
        }
        
        // Clear container
        consoleContainer.innerHTML = '';
        
        // Reset status
        updateStatus('Disconnected', 'info');
        
        // Disable controls
        ctrlAltDelButton.disabled = true;
        scaleToggleButton.disabled = true;
        fullscreenButton.disabled = true;
        
        // Close modal
        consoleModal.classList.remove('is-active');
    }
    
    // Toggle viewport scaling
    function toggleScale() {
        if (rfb) {
            scaleViewport = !scaleViewport;
            rfb.scaleViewport = scaleViewport;
            updateScaleButton();
            console.log('Viewport scaling:', scaleViewport ? 'enabled' : 'disabled');
        }
    }
    
    // Update scale button appearance
    function updateScaleButton() {
        if (scaleViewport) {
            scaleToggleButton.classList.add('is-info');
            scaleToggleButton.classList.remove('is-light');
            const span = scaleToggleButton.querySelector('span:not(.icon)');
            if (span) span.textContent = 'Scale: On';
            scaleToggleButton.title = 'Scaling enabled - Click to disable and show original size';
        } else {
            scaleToggleButton.classList.remove('is-info');
            scaleToggleButton.classList.add('is-light');
            const span = scaleToggleButton.querySelector('span:not(.icon)');
            if (span) span.textContent = 'Scale: Off';
            scaleToggleButton.title = 'Scaling disabled - Click to enable responsive scaling';
        }
    }
    
    // Send Ctrl+Alt+Del
    function sendCtrlAltDel() {
        if (rfb) {
            rfb.sendCtrlAltDel();
            console.log('Sent Ctrl+Alt+Del');
        }
    }
    
    // Toggle fullscreen
    function toggleFullscreen() {
        const modalCard = consoleModal.querySelector('.modal-card');
        
        if (!document.fullscreenElement) {
            modalCard.requestFullscreen().catch(err => {
                console.error('Error attempting to enable fullscreen:', err);
            });
        } else {
            document.exitFullscreen();
        }
    }
    
    // Event listeners
    consoleButton.addEventListener('click', function() {
        consoleModal.classList.add('is-active');
        // Small delay to ensure modal is visible before connecting
        setTimeout(openConsole, 100);
    });
    
    consoleClose.addEventListener('click', closeConsole);
    consoleDisconnect.addEventListener('click', closeConsole);
    
    consoleModal.querySelector('.modal-background').addEventListener('click', function() {
        if (confirm('Are you sure you want to close the console?')) {
            closeConsole();
        }
    });
    
    ctrlAltDelButton.addEventListener('click', sendCtrlAltDel);
    scaleToggleButton.addEventListener('click', toggleScale);
    fullscreenButton.addEventListener('click', toggleFullscreen);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (rfb) {
            rfb.disconnect();
        }
    });
</script>

{{end}}